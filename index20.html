<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatGPTToLoadPDF - PDF â†’ ç”»åƒï¼†ãƒ†ã‚­ã‚¹ãƒˆ ZIP</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- pdf.js -->
  <style>
    :root{
      --bg: #fff4df;            /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
      --card: rgba(255,255,255,.72);
      --card2: rgba(255,255,255,.52);
      --ink: #2b2b2b;
      --muted: rgba(43,43,43,.62);
      --line: rgba(43,43,43,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.10);
      --shadow2: 0 10px 28px rgba(0,0,0,.08);
      --radius: 22px;
      --radius2: 16px;
      --accent: #ff7a59;
      --accent2: #ffd0c4;
      --good: #1e7f5a;
      --bad: #b93a3a;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Noto Sans JP", system-ui, -apple-system, Segoe UI, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1000px 700px at 50% 90%, rgba(255,255,255,.50), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 34px 18px 60px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex; gap:14px; align-items:center;
      padding: 16px 18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow2);
      border: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }

    .logo{
      width: 44px; height:44px; border-radius: 16px;
      background:
        radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,0) 55%),
        linear-gradient(135deg, var(--accent), #ffb07a);
      box-shadow: 0 12px 26px rgba(255,122,89,.25);
      position:relative;
      flex:0 0 auto;
    }
    .logo::after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,.85);
    }

    h1{
      font-size: 18px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.25;
    }
    .subtitle{
      margin:4px 0 0;
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.5;
    }

    .pillrow{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      margin-top: 4px;
    }
    .pill{
      font-size: 12px;
      padding: 9px 11px;
      border-radius: 999px;
      background: rgba(255,255,255,.62);
      border: 1px solid var(--line);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
      backdrop-filter: blur(10px);
      color: rgba(43,43,43,.78);
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(30,127,90,.12);
    }

    main{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
    }

    @media (max-width: 880px){
      header{ flex-direction:column; }
      .pillrow{ justify-content:flex-start; }
      main{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: var(--shadow);
      border: 1px solid var(--line);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(900px 260px at 20% 0%, rgba(255,122,89,.18), transparent 60%);
      pointer-events:none;
    }

    .cardInner{
      position:relative;
      padding: 18px;
    }

    .drop{
      border-radius: var(--radius);
      padding: 18px;
      border: 2px dashed rgba(43,43,43,.18);
      background: rgba(255,255,255,.55);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
      transition: .18s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      min-height: 260px;
      position:relative;
      overflow:hidden;
    }
    .drop::after{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(400px 220px at 20% 20%, rgba(255,122,89,.16), transparent 55%),
        radial-gradient(360px 220px at 80% 60%, rgba(255,176,122,.16), transparent 55%);
      transform: rotate(-6deg);
      opacity:.9;
      pointer-events:none;
    }
    .drop.active{
      transform: translateY(-1px);
      border-color: rgba(255,122,89,.55);
      box-shadow:
        0 18px 40px rgba(255,122,89,.12),
        inset 0 0 0 1px rgba(255,255,255,.45);
    }

    .dropContent{
      position:relative;
      max-width: 520px;
    }

    .big{
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 8px;
      letter-spacing:.2px;
    }
    .small{
      margin:0;
      font-size: 13px;
      color: var(--muted);
      line-height:1.7;
    }

    .actions{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }

    button, .btn{
      border: 1px solid rgba(43,43,43,.12);
      background: rgba(255,255,255,.75);
      color: var(--ink);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 13px;
      cursor:pointer;
      transition: .16s ease;
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      backdrop-filter: blur(10px);
      display:inline-flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      user-select:none;
    }
    button:hover, .btn:hover{ transform: translateY(-1px); }
    button:active, .btn:active{ transform: translateY(0px); }
    button.primary{
      background: linear-gradient(135deg, var(--accent), #ffb07a);
      border-color: rgba(255,122,89,.35);
      box-shadow: 0 16px 30px rgba(255,122,89,.20);
      color: #1d0f0b;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
      box-shadow:none;
    }

    .rightCol .stat{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.58);
      margin-bottom: 10px;
    }
    .stat .k{ font-size:12px; color: var(--muted); }
    .stat .v{ font-size:13px; font-weight:700; }

    .progressWrap{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.58);
    }

    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(43,43,43,.10);
      overflow:hidden;
      position:relative;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), #ffb07a);
      transition: width .18s ease;
    }

    .log{
      margin-top: 10px;
      font-size: 12px;
      color: rgba(43,43,43,.78);
      line-height:1.6;
      max-height: 240px;
      overflow:auto;
      padding-right: 6px;
    }
    .log .muted{ color: var(--muted); }
    .log .good{ color: var(--good); font-weight:700; }
    .log .bad{ color: var(--bad); font-weight:700; }

    .hint{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      line-height:1.6;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.50);
    }

    .footer{
      margin-top: 16px;
      font-size: 12px;
      color: rgba(43,43,43,.62);
      text-align:center;
    }

    input[type="file"]{ display:none; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.65);
      color: rgba(43,43,43,.70);
      display:inline-block;
      margin: 0 2px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ChatGPTToLoadPDF</h1>
          <p class="subtitle">PDF ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— â†’ å„ãƒšãƒ¼ã‚¸ã‚’ã€Œç”»åƒ(.png)ã€ã¨ã€Œãƒ†ã‚­ã‚¹ãƒˆ(.txt)ã€ã«åˆ†è§£ã—ã€<br>ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ä»˜ã ZIP ã‚’è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill"><span class="dot"></span>ãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼ˆä¿å­˜ãªã—ï¼‰</div>
        <div class="pill">å‡ºåŠ›ï¼š<span class="kbd">ChatGPTToLoadPDF/</span></div>
        <div class="pill">1ãƒšãƒ¼ã‚¸= ç”»åƒ + ãƒ†ã‚­ã‚¹ãƒˆ</div>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="cardInner">
          <div id="drop" class="drop" role="button" tabindex="0" aria-label="PDFã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—">
            <div class="dropContent">
              <p class="big">PDF ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
              <p class="small">
                ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã‹ã‚‰ PDF ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚<br>
                å¤‰æ›å¾Œã€ZIP ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆãƒšãƒ¼ã‚¸æ•°ã«å¿œã˜ã¦æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰ã€‚
              </p>
              <div class="actions">
                <label class="btn" for="fileInput">ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                <button id="btnDemo" type="button" title="æ“ä½œèª¬æ˜ã‚’ãƒ­ã‚°ã«è¡¨ç¤º">âœ¨ ä½¿ã„æ–¹ï¼ˆãƒ­ã‚°è¡¨ç¤ºï¼‰</button>
              </div>
              <input id="fileInput" type="file" accept="application/pdf" />
            </div>
          </div>

          <div class="footer">
            è§£å‡ã™ã‚‹ã¨ <span class="kbd">ChatGPTToLoadPDF</span> ãƒ•ã‚©ãƒ«ãƒ€ â†’ <span class="kbd">Nãƒšãƒ¼ã‚¸ç›®ãƒ•ã‚©ãƒ«ãƒ€</span> â†’
            <span class="kbd">Nãƒšãƒ¼ã‚¸ç›®ç”»åƒ.png</span> / <span class="kbd">Nãƒšãƒ¼ã‚¸ç›®ãƒ†ã‚­ã‚¹ãƒˆ.txt</span>
          </div>
        </div>
      </section>

      <aside class="rightCol">
        <div class="card">
          <div class="cardInner">
            <div class="stat">
              <div class="k">é¸æŠä¸­ãƒ•ã‚¡ã‚¤ãƒ«</div>
              <div class="v" id="stFile">æœªé¸æŠ</div>
            </div>
            <div class="stat">
              <div class="k">ãƒšãƒ¼ã‚¸æ•°</div>
              <div class="v" id="stPages">-</div>
            </div>
            <div class="stat">
              <div class="k">çŠ¶æ…‹</div>
              <div class="v" id="stState">å¾…æ©Ÿä¸­</div>
            </div>

            <div class="actions" style="justify-content:flex-start;margin-top:12px;">
              <button id="btnConvert" class="primary" type="button" disabled>â¬‡ï¸ å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
              <button id="btnCancel" type="button" disabled>ğŸ›‘ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>

            <div class="progressWrap">
              <div class="bar" aria-label="é€²æ—ãƒãƒ¼"><div id="barFill"></div></div>
              <div class="log" id="log" aria-live="polite"></div>
            </div>

            <div class="hint">
              <b>è£œè¶³ï¼š</b> PDF ã®å†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆ/ç”»åƒï¼‰ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã—ã¾ã™ã€‚<br>
              å·¨å¤§PDFã¯ãƒ¡ãƒ¢ãƒªè² è·ãŒé«˜ã„ã®ã§ã€å¿…è¦ãªã‚‰åˆ†å‰²ã—ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>
<!-- pdf.js æœ¬ä½“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>


<script>

(async() => {

  async function loadPdfJsFromUrl({
    pdfUrl = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",
    workerUrl = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",
    globalName = "pdfjsLib",
    timeoutMs = 200,
  } = {}) {
    // æ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãªã‚‰ãã‚Œã‚’ä½¿ã†
    if (window[globalName]) {
      window[globalName].GlobalWorkerOptions.workerSrc = workerUrl;
      return window[globalName];
    }

    // èª­ã¿è¾¼ã¿æ¸ˆã¿scriptãŒã‚ã‚‹ã‹æ¢ã™ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
    const existing = [...document.scripts].find(s => s.src === pdfUrl);
    if (existing) {
      // ã™ã§ã«DOMã«ã‚ã‚‹ã®ã«ã¾ã windowã«ç”Ÿãˆã¦ãªã„ â†’ å°‘ã—å¾…ã¤
      const start = Date.now();
      while (!window[globalName]) {
        if (Date.now() - start > timeoutMs) {
          throw new Error("pdf.min.js ã¯èª­ã¿è¾¼ã¿æ¸ˆã¿ã®ã¯ãšã§ã™ãŒ pdfjsLib ãŒç”Ÿãˆã¾ã›ã‚“ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ã€‚CSP/ãƒ–ãƒ­ãƒƒã‚¯/404ç­‰ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
        }
        await new Promise(r => setTimeout(r, 50));
      }
      window[globalName].GlobalWorkerOptions.workerSrc = workerUrl;
      return window[globalName];
    }

    // æ–°è¦ã«scriptã‚’æŒ¿å…¥ã—ã¦ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚’å¾…ã¤
    await new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = pdfUrl;
      s.async = true;

      const timer = setTimeout(() => {
        reject(new Error("pdf.min.js ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/CSP/URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"));
      }, timeoutMs);

      s.onload = () => {
        clearTimeout(timer);
        resolve();
      };
      s.onerror = () => {
        clearTimeout(timer);
        reject(new Error("pdf.min.js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€CSPã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"));
      };

      document.head.appendChild(s);
    });

    if (!window[globalName]) {
      throw new Error("pdf.min.js ã¯ãƒ­ãƒ¼ãƒ‰å®Œäº†ã—ã¾ã—ãŸãŒ pdfjsLib ãŒå®šç¾©ã•ã‚Œã¾ã›ã‚“ã€‚åˆ¥åã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹/å£Šã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    }

    // worker URL ã‚’è¨­å®š
    window[globalName].GlobalWorkerOptions.workerSrc = workerUrl;
    return window[globalName];
  }

const pdfjsLib = await loadPdfJsFromUrl();
  // --- pdf.js worker è¨­å®šï¼ˆCDNã«åˆã‚ã›ã‚‹ï¼‰ ---
  // pdfjsLib ã¯ pdf.min.js ã«ã‚ˆã‚Šã‚°ãƒ­ãƒ¼ãƒãƒ«æä¾›
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

  // --- UI refs ---
  const drop = document.getElementById("drop");
  const fileInput = document.getElementById("fileInput");
  const btnConvert = document.getElementById("btnConvert");
  const btnCancel = document.getElementById("btnCancel");
  const btnDemo = document.getElementById("btnDemo");

  const stFile = document.getElementById("stFile");
  const stPages = document.getElementById("stPages");
  const stState = document.getElementById("stState");
  const barFill = document.getElementById("barFill");
  const logEl = document.getElementById("log");

  // --- state ---
  let selectedFile = null;
  let pdfDoc = null;
  let cancelRequested = false;

  // --- helpers ---
  const padPageLabel = (n) => `${n}ãƒšãƒ¼ã‚¸ç›®`;
  const setState = (text) => (stState.textContent = text);

  function logLine(html, cls="") {
    const div = document.createElement("div");
    if (cls) div.className = cls;
    div.innerHTML = html;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function resetUI(keepLog=false) {
    selectedFile = null;
    pdfDoc = null;
    cancelRequested = false;

    stFile.textContent = "æœªé¸æŠ";
    stPages.textContent = "-";
    setState("å¾…æ©Ÿä¸­");
    barFill.style.width = "0%";

    btnConvert.disabled = true;
    btnCancel.disabled = true;

    if (!keepLog) {
      logEl.innerHTML = "";
      logLine(`<span class="muted">PDF ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã—ã¦ãã ã•ã„ã€‚</span>`);
    }
  }

  function setProgress(done, total) {
    const pct = total <= 0 ? 0 : Math.max(0, Math.min(100, Math.round((done / total) * 100)));
    barFill.style.width = pct + "%";
  }

  async function fileToArrayBuffer(file) {
    return await file.arrayBuffer();
  }

  function canvasToBlob(canvas, type="image/png", quality=1.0) {
    return new Promise((resolve) => canvas.toBlob(resolve, type, quality));
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼šyåº§æ¨™ã®å¤‰åŒ–ã‚’è¦‹ã¦æ”¹è¡Œã‚’å…¥ã‚Œã‚‹ç°¡æ˜“æ•´å½¢
  function textContentToReadable(textContent) {
    const items = textContent.items || [];
    let out = [];
    let lastY = null;

    for (const it of items) {
      const str = (it.str ?? "").replace(/\s+/g, " ").trim();
      if (!str) continue;

      // transform[5] ãŒ yï¼ˆPDFåº§æ¨™ï¼‰
      const y = Array.isArray(it.transform) ? it.transform[5] : null;

      if (lastY !== null && y !== null) {
        // è¡ŒãŒå¤‰ã‚ã£ãŸã£ã½ã„ãªã‚‰æ”¹è¡Œï¼ˆé–¾å€¤ã¯é©åº¦ã«ï¼‰
        if (Math.abs(y - lastY) > 6) out.push("\n");
        else out.push(" ");
      } else {
        if (out.length) out.push(" ");
      }

      out.push(str);
      if (y !== null) lastY = y;
    }

    // é€£ç¶šæ”¹è¡Œ/ã‚¹ãƒšãƒ¼ã‚¹ã‚’æ•´ãˆã‚‹
    return out.join("")
      .replace(/[ \t]+\n/g, "\n")
      .replace(/\n{3,}/g, "\n\n")
      .trim() + "\n";
  }

  // --- file handling ---
  async function loadPdfFromFile(file) {
    if (!file || file.type !== "application/pdf") {
      logLine(`<span class="bad">PDF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</span>`);
      return;
    }
    resetUI(true);
    selectedFile = file;
    stFile.textContent = file.name;

    setState("PDF èª­ã¿è¾¼ã¿ä¸­â€¦");
    logLine(`<span class="muted">PDF ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™â€¦</span>`);

    const buf = await fileToArrayBuffer(file);
    const loadingTask = pdfjsLib.getDocument({ data: buf });
    pdfDoc = await loadingTask.promise;

    stPages.textContent = String(pdfDoc.numPages);
    btnConvert.disabled = false;

    setState("æº–å‚™å®Œäº†");
    logLine(`<span class="good">èª­ã¿è¾¼ã¿å®Œäº†ï¼š</span> ${pdfDoc.numPages} ãƒšãƒ¼ã‚¸`);
    logLine(`<span class="muted">ã€ŒZIP ã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’æŠ¼ã™ã¨å¤‰æ›ãŒå§‹ã¾ã‚Šã¾ã™ã€‚</span>`);
  }

  // --- conversion ---
  async function convertToZipAndDownload() {
    if (!pdfDoc || !selectedFile) return;

    cancelRequested = false;
    btnConvert.disabled = true;
    btnCancel.disabled = false;

    const totalPages = pdfDoc.numPages;
    const totalSteps = totalPages * 2; // (ç”»åƒ+ãƒ†ã‚­ã‚¹ãƒˆ)*ãƒšãƒ¼ã‚¸
    let step = 0;

    setState("å¤‰æ›ä¸­â€¦");
    logLine(`<hr style="border:none;border-top:1px solid rgba(43,43,43,.10);margin:10px 0;">`);
    logLine(`<b>å¤‰æ›é–‹å§‹ï¼š</b> ${totalPages} ãƒšãƒ¼ã‚¸`);
    setProgress(0, totalSteps);

    // Canvasï¼ˆå†åˆ©ç”¨ï¼‰
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { alpha: false });

    for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
      if (cancelRequested) throw new Error("CANCELLED");

      const pageLabel = padPageLabel(pageNum);

      // ---- ç”»åƒåŒ– ----
      logLine(`ğŸ–¼ï¸ ${pageLabel}ï¼šç”»åƒç”Ÿæˆä¸­â€¦ <span class="muted">(PNG)</span>`);
      const page = await pdfDoc.getPage(pageNum);

      // è¦‹ã‚„ã™ã•å„ªå…ˆã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå¤§ãã™ãã‚‹PDFã§ã‚‚ç ´ç¶»ã—ã«ãã„å€¤ï¼‰
      const targetMaxWidth = 1600; // px
      const viewport1 = page.getViewport({ scale: 1.0 });
      const scale = Math.max(1.0, Math.min(3.0, targetMaxWidth / viewport1.width));
      const viewport = page.getViewport({ scale });

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      // èƒŒæ™¯ã‚’ç™½ã§å¡—ã‚‹ï¼ˆé€æ˜ã‚’é¿ã‘ã‚‹ï¼‰
      ctx.save();
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();

      await page.render({ canvasContext: ctx, viewport }).promise;

      const imgBlob = await canvasToBlob(canvas, "image/png", 1.0);
      if (!imgBlob) throw new Error("PNG ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");

      downloadBlob(imgBlob, `${pageLabel}ç”»åƒ.png`);
      step++; setProgress(step, totalSteps);

      // ---- ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º ----
      if (cancelRequested) throw new Error("CANCELLED");
      logLine(`ğŸ“ ${pageLabel}ï¼šãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºä¸­â€¦ <span class="muted">(TXT)</span>`);
      const textContent = await page.getTextContent({ includeMarkedContent: true });
      const txt = textContentToReadable(textContent);

      // UTF-8ãƒ†ã‚­ã‚¹ãƒˆã§æ ¼ç´
      const txtBlob = new Blob([txt], { type: "text/plain;charset=utf-8" });
      downloadBlob(txtBlob, `${pageLabel}ãƒ†ã‚­ã‚¹ãƒˆ.txt`);
      step++; setProgress(step, totalSteps);

      logLine(`âœ… ${pageLabel}ï¼šå®Œäº†`, "good");
    }

    setState("å®Œäº†");
    btnCancel.disabled = true;
    logLine(`<span class="good">ã™ã¹ã¦å®Œäº†ï¼</span> å„ãƒšãƒ¼ã‚¸ã® PNG / TXT ã‚’é †ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
  }

  // --- events: drag & drop ---
  function prevent(e){ e.preventDefault(); e.stopPropagation(); }

  ["dragenter","dragover"].forEach(ev => {
    drop.addEventListener(ev, (e) => {
      prevent(e);
      drop.classList.add("active");
    });
  });

  ["dragleave","drop"].forEach(ev => {
    drop.addEventListener(ev, (e) => {
      prevent(e);
      drop.classList.remove("active");
    });
  });

  drop.addEventListener("drop", async (e) => {
    const files = e.dataTransfer?.files;
    if (!files || !files.length) return;
    const file = files[0];
    await loadPdfFromFile(file);
  });

  // keyboard accessible
  drop.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      fileInput.click();
    }
  });

  fileInput.addEventListener("change", async () => {
    const file = fileInput.files?.[0] || null;
    if (file) await loadPdfFromFile(file);
    fileInput.value = ""; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«å†é¸æŠã§ãã‚‹ã‚ˆã†ã«
  });

  btnConvert.addEventListener("click", async () => {
    try{
      btnDemo.disabled = true;
      await convertToZipAndDownload();
    }catch(err){
      if (String(err?.message) === "CANCELLED") {
        setState("ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
        logLine(`<span class="bad">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚</span>`);
      } else {
        console.error(err);
        setState("ã‚¨ãƒ©ãƒ¼");
        logLine(`<span class="bad">ã‚¨ãƒ©ãƒ¼ï¼š</span> ${String(err?.message || err)}`);
        logLine(`<span class="muted">â€» PDF ãŒéå¸¸ã«å¤§ãã„å ´åˆã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã§å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</span>`);
      }
      btnConvert.disabled = !pdfDoc;
      btnCancel.disabled = true;
      btnDemo.disabled = false;
    }
  });

  btnCancel.addEventListener("click", () => {
    cancelRequested = true;
    btnCancel.disabled = true;
    setState("ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦æ±‚ä¸­â€¦");
    logLine(`<span class="muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¦æ±‚ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚å®‰å…¨ã«åœæ­¢ã—ã¾ã™â€¦</span>`);
  });

  btnDemo.addEventListener("click", () => {
    logLine(`<hr style="border:none;border-top:1px solid rgba(43,43,43,.10);margin:10px 0;">`);
    logLine(`ä½¿ã„æ–¹ï¼š`);
    logLine(`1) PDF ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ï¼‰`);
    logLine(`2) å³å´ã®ã€ŒZIP ã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’æŠ¼ã™`);
    logLine(`3) ZIP ã‚’è§£å‡ â†’ <span class="kbd">ChatGPTToLoadPDF</span> ãƒ•ã‚©ãƒ«ãƒ€å†…ã«ãƒšãƒ¼ã‚¸åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚`);
    logLine(`<span class="muted">ãƒ’ãƒ³ãƒˆï¼š</span> ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥é–‹ãï¼ˆfile://ï¼‰ã§ã‚‚å‹•ãã¾ã™ãŒã€ç’°å¢ƒã«ã‚ˆã£ã¦ã¯ãƒ­ãƒ¼ã‚«ãƒ«åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€ã†ã¾ãã„ã‹ãªã„å ´åˆã¯ç°¡æ˜“ã‚µãƒ¼ãƒãƒ¼ï¼ˆä¾‹ï¼šVSCode Live Serverï¼‰ã§é–‹ãã¨å®‰å®šã—ã¾ã™ã€‚`);
  });

  // init
  resetUI(false);
})();
</script>
</body>
</html>
