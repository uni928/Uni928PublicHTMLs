<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Odds-park å‡ºé¦¬è¡¨ â†’ ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°</title>
  <style>
    :root{
      --bg0:#070A10;
      --bg1:#0B1020;
      --card:#0E1630cc;
      --card2:#0E1630f2;
      --txt:#EAF0FF;
      --muted:#A8B3D6;
      --line:#243055;
      --accent:#7C5CFF;
      --accent2:#2EE59D;
      --warn:#FFB020;
      --bad:#FF5C7A;
      --good:#2EE59D;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --r: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--txt);
      background:
        radial-gradient(1100px 700px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(900px 550px at 110% 10%, rgba(46,229,157,.25), transparent 55%),
        radial-gradient(900px 650px at 60% 110%, rgba(255,92,122,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, #070B14);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:28px 18px 44px}
    .topbar{
      display:flex; gap:14px; align-items:center; justify-content:space-between;
      margin-bottom:18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: conic-gradient(from 210deg, var(--accent), var(--accent2), #4CB7FF, var(--accent));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 35%),
                  linear-gradient(120deg, transparent 40%, rgba(255,255,255,.18), transparent 60%);
      transform: rotate(18deg);
    }
    .titleblock h1{
      font-size:18px; margin:0; letter-spacing:.2px;
    }
    .titleblock p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--line);
      background:rgba(14,22,48,.55);
      border-radius:999px;
      box-shadow: var(--shadow2);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .pill b{color:var(--txt);font-weight:650}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(14,22,48,.74), rgba(14,22,48,.48));
      border:1px solid rgba(36,48,85,.75);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 220px at 15% 0%, rgba(124,92,255,.18), transparent 60%),
                  radial-gradient(500px 220px at 95% 0%, rgba(46,229,157,.14), transparent 60%);
      pointer-events:none;
      filter:saturate(1.2);
    }
    .card > *{position:relative}
    .cardHd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(36,48,85,.55);
      background: rgba(8,12,24,.38);
    }
    .cardHd h2{
      margin:0; font-size:14px; letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: linear-gradient(180deg, var(--accent), #4CB7FF);
      box-shadow: 0 0 0 4px rgba(124,92,255,.12);
    }
    .cardBd{padding:14px 16px}
    .help{
      color:var(--muted);
      font-size:12px; line-height:1.65;
    }
    .actions{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      margin-top:12px;
    }
    button, .btn{
      appearance:none;border:1px solid rgba(36,48,85,.9);
      background: rgba(10,16,34,.8);
      color:var(--txt);
      padding:11px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      font-weight:650;
      font-size:13px;
      display:inline-flex; align-items:center; gap:9px;
      user-select:none;
    }
    button:hover{transform: translateY(-1px); border-color: rgba(124,92,255,.7); background: rgba(12,18,38,.92)}
    button:active{transform: translateY(0px) scale(.99)}
    button.primary{
      border-color: rgba(124,92,255,.85);
      background: linear-gradient(135deg, rgba(124,92,255,.92), rgba(46,229,157,.78));
      box-shadow: 0 16px 36px rgba(124,92,255,.22);
    }
    button.primary:hover{filter:saturate(1.15)}
    button.ghost{
      background: rgba(10,16,34,.4);
      border-style:dashed;
      color: var(--muted);
      font-weight:600;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none !important;
    }
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border:1px solid rgba(36,48,85,.8);
      border-bottom-color: rgba(36,48,85,1);
      border-radius:8px;
      background: rgba(6,10,22,.65);
      color:var(--muted);
    }
    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:16px;
      border:1px solid rgba(36,48,85,.75);
      background: rgba(6,10,22,.55);
      color: var(--txt);
      padding:12px 12px;
      font-size:12px;
      line-height:1.55;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
      outline:none;
    }
    textarea:focus{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .metaRow{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:12px;
      align-items:center;
      justify-content:space-between;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      font-size:11px; color:var(--muted);
      padding:6px 9px;
      border:1px solid rgba(36,48,85,.7);
      background: rgba(10,16,34,.48);
      border-radius:999px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .chip b{color:var(--txt); font-weight:700}
    .status{
      font-size:12px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .status .lamp{
      width:10px;height:10px;border-radius:99px;
      background: rgba(168,179,214,.5);
      box-shadow: 0 0 0 4px rgba(168,179,214,.10);
    }
    .status.ok .lamp{background: rgba(46,229,157,.9); box-shadow: 0 0 0 4px rgba(46,229,157,.12)}
    .status.bad .lamp{background: rgba(255,92,122,.9); box-shadow: 0 0 0 4px rgba(255,92,122,.12)}
    .status.warn .lamp{background: rgba(255,176,32,.95); box-shadow: 0 0 0 4px rgba(255,176,32,.14)}
    .searchRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 6px;
    }
    input[type="text"]{
      flex:1;
      min-width:220px;
      border-radius: 14px;
      border:1px solid rgba(36,48,85,.75);
      background: rgba(6,10,22,.55);
      color: var(--txt);
      padding:11px 12px;
      outline:none;
    }
    input[type="text"]:focus{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 4px rgba(124,92,255,.14);
    }
    select{
      border-radius: 14px;
      border:1px solid rgba(36,48,85,.75);
      background: rgba(6,10,22,.55);
      color: var(--txt);
      padding:11px 10px;
      outline:none;
      cursor:pointer;
      min-width: 160px;
    }
    .tableWrap{
      margin-top:12px;
      border:1px solid rgba(36,48,85,.65);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(6,10,22,.35);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      text-align:left;
      padding:10px 10px;
      color: var(--muted);
      font-weight:700;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(36,48,85,.6);
      background: rgba(10,16,34,.55);
      position:sticky; top:0;
      backdrop-filter: blur(8px);
      z-index:1;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(36,48,85,.35);
      vertical-align:top;
    }
    tbody tr:hover{
      background: rgba(124,92,255,.06);
    }
    .num{font-family:var(--mono); color:var(--txt)}
    .muted{color:var(--muted)}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(36,48,85,.7);
      background: rgba(10,16,34,.5);
      color: var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(46,229,157,.45); color: rgba(46,229,157,.95); background: rgba(46,229,157,.08)}
    .badge.bad{border-color: rgba(255,92,122,.45); color: rgba(255,92,122,.95); background: rgba(255,92,122,.08)}
    .rank{
      font-family:var(--mono);
      font-weight:800;
      padding:4px 8px;
      border-radius: 12px;
      background: rgba(124,92,255,.12);
      border:1px solid rgba(124,92,255,.35);
      display:inline-block;
      min-width: 42px;
      text-align:center;
    }
    .miniGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:6px;
      margin-top:6px;
    }
    .mini{
      border:1px solid rgba(36,48,85,.55);
      background: rgba(10,16,34,.42);
      border-radius: 12px;
      padding:7px 8px;
      line-height:1.25;
      min-height: 56px;
    }
    .mini .t{font-family:var(--mono); font-weight:800}
    .mini .s{color:var(--muted); font-size:10px; margin-top:2px}
    .mini.best{
      border-color: rgba(46,229,157,.55);
      background: rgba(46,229,157,.07);
    }
    .mini.na{
      opacity:.6;
      border-style:dashed;
    }
    .foot{
      margin-top:14px;
      color: var(--muted);
      font-size:11px;
      line-height:1.6;
    }
    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform: translateX(-50%);
      background: rgba(10,16,34,.92);
      border:1px solid rgba(36,48,85,.8);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow2);
      display:none;
      gap:10px;
      align-items:center;
      max-width: min(720px, calc(100vw - 26px));
      backdrop-filter: blur(10px);
      z-index:9999;
      font-size:12px;
    }
    .toast.show{display:flex}
    .toast .tDot{width:10px;height:10px;border-radius:99px;background:rgba(46,229,157,.95);box-shadow:0 0 0 4px rgba(46,229,157,.14)}
    .toast.bad .tDot{background:rgba(255,92,122,.95);box-shadow:0 0 0 4px rgba(255,92,122,.14)}
    .toast.warn .tDot{background:rgba(255,176,32,.95);box-shadow:0 0 0 4px rgba(255,176,32,.14)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titleblock">
          <h1>å‡ºé¦¬è¡¨ â†’ ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°ï¼ˆä¸­å¤®ç«¶é¦¬ã‚’å«ã‚€é¦¬ã¯å‚è€ƒã«ã—ãªã„ã§ä¸‹ã•ã„ï¼‰</h1>
        </div>
      </div>
      <div class="pill" title="è§£æã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å®Œçµã—ã¾ã™ã€‚å¤–éƒ¨é€ä¿¡ã—ã¾ã›ã‚“ã€‚">
        <span>ğŸ”’</span><b>ãƒ­ãƒ¼ã‚«ãƒ«è§£æ</b><span class="muted">ï¼ˆå¤–éƒ¨é€ä¿¡ãªã—ï¼‰</span>
      </div>
    </div>

    <div class="grid">
      <!-- INPUT -->
      <div class="card">
        <div class="cardHd">
          <h2><span class="dot"></span>å…¥åŠ›ï¼ˆå‡ºé¦¬è¡¨HTMLï¼‰</h2>
          <span class="badge">æ¨å¥¨: <span class="kbd">Ctrl</span>+<span class="kbd">A</span> â†’ <span class="kbd">Ctrl</span>+<span class="kbd">C</span></span>
        </div>
        <div class="cardBd">
          <div class="help">
            1) ã‚ªãƒƒã‚ºãƒ‘ãƒ¼ã‚¯ã®å‡ºé¦¬è¡¨ãƒšãƒ¼ã‚¸ã§ã€Œãƒšãƒ¼ã‚¸å…¨ä½“ã®HTMLã€ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯â†’ãƒšãƒ¼ã‚¸ã®ã‚½ãƒ¼ã‚¹ã‚’è¡¨ç¤ºâ†’å…¨é¸æŠâ†’ã‚³ãƒ”ãƒ¼ã€ç­‰ï¼‰<br/>
            2) ã“ã®ãƒšãƒ¼ã‚¸ã§ <b>ï¼»ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ï¼½</b> ã¾ãŸã¯ç›´æ¥ãƒšãƒ¼ã‚¹ãƒˆ<br/>
            3) <b>ï¼»æŒ‡æ•°ã‚’å‡ºã™ï¼½</b> ã‚’æŠ¼ã™ã¨ã€å„é¦¬ã®å‰èµ°ã€œ5èµ°å‰ã‹ã‚‰æŒ‡æ•°ã‚’è¨ˆç®—ã—ã¦ä¸¦ã¹ã¾ã™ã€‚
          </div>

          <div class="actions">
            <button id="btnPaste" class="ghost" title="navigator.clipboard.readText() ã‚’ä½¿ã„ã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨©é™ãŒå¿…è¦ï¼‰">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘</button>
            <button id="btnCalc" class="primary">âš¡ æŒ‡æ•°ã‚’å‡ºã™</button>
            <button id="btnClear">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
          </div>

          <div class="metaRow">
            <div class="chips">
              <span class="chip">æŒ‡æ•°: <b>(time * 1000 / distance)<sup>0.9</sup></b></span>
              <span class="chip">è©•ä¾¡: <b>å°ã•ã„ã»ã©é€Ÿã„</b></span>
              <span class="chip">æŠ½å‡º: <b>å‰èµ°ã€œ5èµ°å‰</b></span>
            </div>
            <div id="status" class="status"><span class="lamp"></span><span id="statusText">æœªè§£æ</span></div>
          </div>

          <div style="margin-top:12px">
            <textarea id="htmlInput" spellcheck="false" placeholder="ã“ã“ã«ã‚ªãƒƒã‚ºãƒ‘ãƒ¼ã‚¯ã®å‡ºé¦¬è¡¨HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆãƒšãƒ¼ã‚¸ã‚½ãƒ¼ã‚¹æ¨å¥¨ï¼‰"></textarea>
          </div>

          <div class="foot">
            â€» ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚Šã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚ã†ã¾ãå‹•ã‹ãªã„å ´åˆã¯ã€ä¸Šã®æ¬„ã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br/>
            â€» ã‚ªãƒƒã‚ºãƒ‘ãƒ¼ã‚¯å´ã®HTMLæ§‹é€ ãŒå¤‰ã‚ã‚‹ã¨æŠ½å‡ºã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãã®å ´åˆã¯è§£æãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆã‚ã›ã¦èª¿æ•´ã§ãã¾ã™ï¼‰ã€‚
          </div>
        </div>
      </div>

      <!-- OUTPUT -->
      <div class="card">
        <div class="cardHd">
          <h2><span class="dot"></span>çµæœï¼ˆå„é¦¬ã®ã‚¹ãƒ”ãƒ¼ãƒ‰æŒ‡æ•°ï¼‰</h2>
          <span class="badge">è¡¨ç¤º: <b>æœ€é€Ÿ(æœ€å°)ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°</b></span>
        </div>
        <div class="cardBd">
          <div class="searchRow">
            <input id="q" type="text" placeholder="æ¤œç´¢ï¼ˆé¦¬å / é¦¬ç•ª / é¨æ‰‹ ãªã©ï¼‰" />
            <select id="sort">
              <option value="bestAsc">ä¸¦ã³: æœ€é€ŸæŒ‡æ•°ï¼ˆå°â†’å¤§ï¼‰</option>
              <option value="bestDesc">ä¸¦ã³: æœ€é€ŸæŒ‡æ•°ï¼ˆå¤§â†’å°ï¼‰</option>
              <option value="avgAsc" selected>ä¸¦ã³: å¹³å‡æŒ‡æ•°ï¼ˆå°â†’å¤§ï¼‰</option>
              <option value="horseNoAsc">ä¸¦ã³: é¦¬ç•ªï¼ˆæ˜‡é †ï¼‰</option>
            </select>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:64px">é †ä½</th>
                  <th style="width:64px">é¦¬ç•ª</th>
                  <th>é¦¬å</th>
                  <th style="width:120px">æœ€é€ŸæŒ‡æ•°</th>
                  <th style="width:120px">å¹³å‡æŒ‡æ•°</th>
                  <th>å‰èµ°ã€œ5èµ°ï¼ˆæŒ‡æ•°ï¼‰</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr>
                  <td colspan="6" class="muted">ã¾ã çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã§HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ï¼»æŒ‡æ•°ã‚’å‡ºã™ï¼½ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="foot">
            ãƒ»æŒ‡æ•°ã¯ <b>(ã‚¿ã‚¤ãƒ  * 1000 / è·é›¢)^0.9</b>ï¼ˆä¾‹: 1:30.0 ã® 1400m â†’ (90*1000/1400)^0.9ï¼‰<br/>
            ãƒ»ã€Œæœ€é€ŸæŒ‡æ•°ã€ã¯å‰èµ°ã€œ5èµ°ã®ã†ã¡ <b>æœ€å°å€¤</b>ï¼ˆ=æœ€ã‚‚é€Ÿã‹ã£ãŸèµ°ã‚Šï¼‰<br/>
            ãƒ»ã€Œå¹³å‡æŒ‡æ•°ã€ã¯ç®—å‡ºã§ããŸèµ°ã‚Šã ã‘ã§å¹³å‡ï¼ˆæ¬ æã¯é™¤å¤–ï¼‰
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <span class="tDot"></span>
    <span id="toastText"></span>
  </div>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const htmlInput = el("htmlInput");
  const btnPaste  = el("btnPaste");
  const btnCalc   = el("btnCalc");
  const btnClear  = el("btnClear");
  const tbody     = el("tbody");
  const status    = el("status");
  const statusText= el("statusText");
  const q         = el("q");
  const sort      = el("sort");

    const pageText = el.body?.textContent || "";
    const isCentral = isCentralRace(pageText);

  // ä¸­å¤®ç«¶é¦¬å ´åä¸€è¦§
  const CENTRAL_RACECOURSES = [
    "æœ­å¹Œ","å‡½é¤¨","ç¦å³¶","æ–°æ½Ÿ","æ±äº¬",
    "ä¸­å±±","ä¸­äº¬","äº¬éƒ½","é˜ªç¥","å°å€‰"
  ];

  // é›£é–¢åœ°æ–¹ï¼ˆé–‹å‚¬åã«å«ã¾ã‚Œã¦ã„ãŸã‚‰è·é›¢Ã—0.95ï¼‰
  // â€»å¿…è¦ã«å¿œã˜ã¦å¢—æ¸›ã—ã¦ãã ã•ã„
  const HARD_LOCAL_KEYWORDS = [
    "å¤§äº•","å·å´","èˆ¹æ©‹","æµ¦å’Œ","é–€åˆ¥"
  ];

  // é–‹å‚¬åã«ä¸­å¤®ç«¶é¦¬å ´ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
  function isCentralRace(text){
    if(!text) return false;
    return CENTRAL_RACECOURSES.some(name => text.includes(name));
  }

  function isHardLocal(text){
    if(!text) return false;
    return HARD_LOCAL_KEYWORDS.some(k => text.includes(k));
  }

  let lastData = [];

  function toast(msg, type="ok"){
    const t = el("toast");
    const tt= el("toastText");
    t.classList.remove("bad","warn");
    if(type==="bad") t.classList.add("bad");
    if(type==="warn") t.classList.add("warn");
    tt.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._timer);
    toast._timer = setTimeout(()=>t.classList.remove("show"), 2400);
  }

  function setStatus(kind, text){
    status.classList.remove("ok","bad","warn");
    if(kind) status.classList.add(kind);
    statusText.textContent = text;
  }

  // --- time "1:33.1" / "58.2" / "2:02.1" -> seconds (float)
  function parseTimeToSeconds(s){
    if(!s) return null;
    s = String(s).trim();
    // keep only first token that looks like time
    const m = s.match(/(\d+:\d{2}(?:\.\d)?|\d{1,2}(?:\.\d)?)/);
    if(!m) return null;
    const t = m[1];
    if(t.includes(":")){
      const [mm, ss] = t.split(":");
      const min = Number(mm);
      const sec = Number(ss);
      if(!Number.isFinite(min) || !Number.isFinite(sec)) return null;
      return min * 60 + sec;
    }
    const sec = Number(t);
    return Number.isFinite(sec) ? sec : null;
  }

  // distance like "ãƒ€1400" "èŠ2000" "ãƒ€ 1400" -> meters (int)
  function parseDistanceMeters(s){
    if(!s) return null;
    s = String(s).replace(/\s+/g,"");
    const m = s.match(/[ãƒ€èŠ](\d{3,4})/);
    if(!m) return null;
    const v = Number(m[1]);
    return Number.isFinite(v) ? v : null;
  }

  // é¦¬å ´çŠ¶æ…‹ã«å¿œã˜ã¦è·é›¢ã‚’è£œæ­£
  function adjustDistanceByCondition(meters, text, isCentral){
    if(!meters) return meters;

    let adjusted = meters;

    // é¦¬å ´çŠ¶æ…‹è£œæ­£
    if(text){
      if(text.includes("ä¸è‰¯")) adjusted /= 1.055;
      else if(text.includes("é‡")) adjusted /= 1.03;
      else if(text.includes("ç¨é‡")) adjusted /= 1.015;
    }

    // èŠè£œæ­£ï¼ˆèŠãŒå«ã¾ã‚Œã‚‹ãªã‚‰è·é›¢Ã—0.9ï¼‰
    // detailText ãŒ "èŠ1600" ã®ã‚ˆã†ã«å…¥ã‚‹æƒ³å®š
    if(text && text.includes("èŠ")){
      adjusted *= 0.9;
    }


    // ä¸­å¤®ç«¶é¦¬å ´è£œæ­£
    if(isCentral){
      adjusted *= 0.9;
    }

    // é›£é–¢åœ°æ–¹è£œæ­£ï¼ˆé–‹å‚¬åãŒé›£é–¢åœ°æ–¹ãªã‚‰è·é›¢Ã—0.95ï¼‰
    if(isHardLocal(text)){
      adjusted *= 0.95;
    }

    return adjusted;
  }

  function calcIndex(seconds, meters){
    const base = 10 * seconds / Math.pow(meters, 0.65);
    return Math.pow(base, 1.25);
  }

  // --- Extract per-horse: horseNo, name, past races (distance+time)
  function parseOddsParkRaceHTML(raw){
    const parser = new DOMParser();
    const doc = parser.parseFromString(raw, "text/html");

    // main table (å‡ºèµ°é¦¬ä¸€è¦§) : class tb72
    const table = doc.querySelector("table.tb72");
    if(!table){
      throw new Error("å‡ºèµ°è¡¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆtable.tb72ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚½ãƒ¼ã‚¹å…¨ä½“ã‚’è²¼ã‚Šä»˜ã‘ãŸã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    const rows = Array.from(table.querySelectorAll("tbody > tr"))
      .filter(tr => {
        // horse row contains HorseDetail link with <strong>é¦¬å</strong>
        return !!tr.querySelector('a[href*="HorseDetail.do"] strong');
      });

    if(rows.length === 0){
      throw new Error("é¦¬è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚HTMLæ§‹é€ ãŒç•°ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
    }

    const horses = rows.map(tr => {
      const horseName = tr.querySelector('a[href*="HorseDetail.do"] strong')?.textContent?.trim() ?? "(ä¸æ˜)";
      const horseNo = tr.querySelector("td.al-center")?.textContent?.trim() ?? ""; // æœ€åˆã«å‡ºã‚‹é¦¬ç•ªã‚»ãƒ«æƒ³å®š
      const centers = Array.from(tr.querySelectorAll("td.showElm.al-center"));
      const horseNoTd =
        centers.find(td => !/bg-\d+/.test(td.className))  // bg-â—¯ ãŒä»˜ã„ã¦ãªã„æ–¹ï¼é¦¬ç•ª
        || centers[1]                                    // å¿µã®ãŸã‚2ç•ªç›®
        || centers[0]                                    // æœ€å¾Œã®ä¿é™º
        || null;
      const horseNoFinal = (horseNoTd?.textContent || horseNo || "").trim().replace(/\s+/g,"");

      // past 5 cells: td.showElm with class like bg-7chaku etc contains racename-small/racedetail/zen5text small
      const pastCells = Array.from(tr.querySelectorAll("td.showElm"))
        .filter(td => /bg-\d+chaku/.test(td.className));

      const past = pastCells.slice(0, 5).map(td => {
       const detailText = td.querySelector(".racedetail small")?.textContent ?? "";
        const rawDist = parseDistanceMeters(detailText);

        const timeText = td.querySelector(".zen5text small")?.textContent ?? td.textContent ?? "";
        const sec = parseTimeToSeconds(timeText);

        // é¦¬å ´çŠ¶æ…‹ï¼ˆç¨é‡ / é‡ / ä¸è‰¯ï¼‰ã‚’å«ã‚€å…¨æ–‡ã‹ã‚‰è·é›¢è£œæ­£
        const adjustedDist = adjustDistanceByCondition(
          rawDist,
          td.textContent || "",
          isCentral
        );

        let idx = null;
        if(adjustedDist && sec){
          idx = calcIndex(sec, adjustedDist);
        }

        return {
          dist: adjustedDist,
         sec,
          idx,
          rawDistance: detailText.trim(),
          rawTime: timeText.trim()
        };
      });

      return { horseNo: horseNoFinal, horseName, past };
    });

    return horses;
  }

  function fmt(n, digits=6){
n = (Math.round(600 - n * 10) - 100) * (Math.round(600 - n * 10) - 100) / 50;
    if(n == null || !Number.isFinite(n)) return "â€”";
    return Number(n).toFixed(1);
  }

  function makeRow(h, rank, minAvgDisp){
    // compute best(min) and avg
    const valid = h.past.map(p=>p.idx).filter(v=>Number.isFinite(v));
    const best = valid.length ? Math.min(...valid) : null;
    const avg  = valid.length ? (valid.reduce((a,b)=>a+b,0)/valid.length) : null;
    const bestDisp = h._bestDisp;
    const avgDisp  = h._avgDisp;

    const bestScore =
      Number.isFinite(bestDisp) && Number.isFinite(minAvgDisp)
        ? Math.pow(bestDisp - minAvgDisp, 2)
        : null;

    const avgScore =
      Number.isFinite(avgDisp) && Number.isFinite(minAvgDisp)
        ? Math.pow(avgDisp - minAvgDisp, 2)
        : null;

console.log();

    const tr = document.createElement("tr");

    const tdRank = document.createElement("td");
    tdRank.innerHTML = `<span class="rank">${rank}</span>`;
    tr.appendChild(tdRank);

    const tdNo = document.createElement("td");
    tdNo.innerHTML = `<span class="num">${h.horseNo || "â€”"}</span>`;
    tr.appendChild(tdNo);

    const tdName = document.createElement("td");
    tdName.innerHTML = `
      <div style="font-weight:800; font-size:13px; letter-spacing:.1px">${escapeHtml(h.horseName)}</div>
    `;
    tr.appendChild(tdName);

    const tdBest = document.createElement("td");
    tdBest.innerHTML = best==null
      ? `<span class="badge bad">ç®—å‡ºä¸å¯</span>`
      : `<div class="num" style="font-weight:900">${bestScore}</div><div class="muted" style="font-size:10px;margin-top:2px">å¤§ãã„ã»ã©é€Ÿã„</div>`;
    tr.appendChild(tdBest);

    const tdAvg = document.createElement("td");
    tdAvg.innerHTML = avg==null
      ? `<span class="badge bad">ç®—å‡ºä¸å¯</span>`
      : `<div class="num" style="font-weight:900">${avgScore}</div><div class="muted" style="font-size:10px;margin-top:2px">æ¬ æé™¤å¤–</div>`;
    tr.appendChild(tdAvg);

    const tdPast = document.createElement("td");
    const bestIdx = best;
    const minis = h.past.map((p,i)=>{
      const ok = Number.isFinite(p.idx);
      const isBest = ok && bestIdx != null && Math.abs(p.idx - bestIdx) < 1e-12;
      const cls = ok ? (isBest ? "mini best" : "mini") : "mini na";
      const label = ["å‰èµ°","å‰ã€…èµ°","3èµ°å‰","4èµ°å‰","5èµ°å‰"][i] || `#${i+1}`;
      const distLabel = p.dist ? `${p.dist}m` : "è·é›¢â€”";
      const timeLabel = p.sec!=null ? secondsToLabel(p.sec) : "ã‚¿ã‚¤ãƒ â€”";
      const idxLabel = ok ? fmt(p.idx, 6) : "â€”";
      return `
        <div class="${cls}" title="${escapeHtml(label)} / ${escapeHtml(p.rawDistance || "")} / ${escapeHtml(p.rawTime || "")}">
          <div class="t">${idxLabel}</div>
          <div class="s">${escapeHtml(label)} Â· ${escapeHtml(distLabel)} Â· ${escapeHtml(timeLabel)}</div>
        </div>
      `;
    }).join("");

    tdPast.innerHTML = `<div class="miniGrid">${minis}</div>`;
    tr.appendChild(tdPast);

    tr.dataset.horseno = (h.horseNo || "").toLowerCase();
    tr.dataset.horsename = (h.horseName || "").toLowerCase();
    tr.dataset.best = best==null ? "" : String(best);
    tr.dataset.avg  = avg==null ? "" : String(avg);

    return tr;
  }

  function secondsToLabel(sec){
    if(sec == null || !Number.isFinite(sec)) return "â€”";
    if(sec >= 60){
      const mm = Math.floor(sec/60);
      const ss = (sec - mm*60).toFixed(1).padStart(4,"0");
      return `${mm}:${ss}`;
    }
    return sec.toFixed(1);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function render(){
    const query = (q.value || "").trim().toLowerCase();
    const sortMode = sort.value;

    let data = [...lastData];

    const avgDispList = data
      .map(h => h._avgDisp)
      .filter(v => Number.isFinite(v));

    const minAvgDisp =
      avgDispList.length > 0
        ? Math.max(...avgDispList)
        : null;

    // sort
    data.sort((a,b)=>{
      const aBest = a._best;
      const bBest = b._best;
      const aAvg = a._avg;
      const bAvg = b._avg;

      if(sortMode === "horseNoAsc"){
        const an = Number(a.horseNo || 9999);
        const bn = Number(b.horseNo || 9999);
        return an - bn;
      }
      if(sortMode === "bestDesc"){
        // best bigger first (note: usually smaller is better)
        if(aBest==null && bBest==null) return 0;
        if(aBest==null) return 1;
        if(bBest==null) return -1;
        return bBest - aBest;
      }
      if(sortMode === "avgAsc"){
        if(aAvg==null && bAvg==null) return 0;
        if(aAvg==null) return 1;
        if(bAvg==null) return -1;
        return aAvg - bAvg;
      }
      // default bestAsc
      if(aBest==null && bBest==null) return 0;
      if(aBest==null) return 1;
      if(bBest==null) return -1;
      return aBest - bBest;
    });

    // filter
    if(query){
      data = data.filter(h=>{
        const hay = `${h.horseNo} ${h.horseName}`.toLowerCase();
        return hay.includes(query);
      });
    }

    tbody.innerHTML = "";
    if(data.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="6" class="muted">è©²å½“ã™ã‚‹é¦¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td>`;
      tbody.appendChild(tr);
      return;
    }

    // ranking by current sort order (when bestAsc is typical)
    data.forEach((h, i)=>{
      tbody.appendChild(makeRow(h, i+1, minAvgDisp));
    });
  }

  function enrichStats(horses){
    return horses.map(h=>{
      const valid = h.past.map(p=>p.idx).filter(v=>Number.isFinite(v));
      h._best = valid.length ? Math.min(...valid) : null;
      h._avg  = valid.length ? (valid.reduce((a,b)=>a+b,0)/valid.length) : null;
      h._bestDisp = toDisplayIndex(h._best);
      h._avgDisp  = toDisplayIndex(h._avg);
      return h;
    });
  }

function toDisplayIndex(idx){
  if (idx == null || !Number.isFinite(idx)) {
    return null;
  }
  return Math.round((idx - 40) * 10);
}

  async function pasteFromClipboard(){
    try{
      if(!navigator.clipboard?.readText){
        toast("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚ŠãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚", "warn");
        return;
      }
      const text = await navigator.clipboard.readText();
      if(!text || text.trim().length < 50){
        toast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã‹ã€å†…å®¹ãŒçŸ­ã™ãã¾ã™ã€‚å‡ºé¦¬è¡¨HTMLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚", "warn");
        return;
      }
      htmlInput.value = text;
      toast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚", "ok");
      setStatus("warn", "æœªè§£æï¼ˆè²¼ã‚Šä»˜ã‘æ¸ˆã¿ï¼‰");
    }catch(e){
      toast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/HTTPS/ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã®å¯èƒ½æ€§ï¼‰ã€‚æ‰‹å‹•è²¼ã‚Šä»˜ã‘ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚", "bad");
      setStatus("bad", "è²¼ã‚Šä»˜ã‘å¤±æ•—");
      console.error(e);
    }
  }

  function looksLikeUrl(text){
    const s = (text || "").trim();
    if(!s) return false;
    // æœ€ä½é™ï¼šhttp(s)ã§å§‹ã¾ã‚‹
    return /^https?:\/\/\S+$/i.test(s);
  }

/**
 * URL ã‹ã‚‰ HTML ã‚’å–å¾—ã™ã‚‹
 * â€» CORS åˆ¶ç´„ã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹å ´åˆã‚ã‚Š
 */
async function fetchHtmlFromUrl(url){
  const res = await fetch(url, {
    method: "GET",
    mode: "cors",
    credentials: "omit",
    redirect: "follow",
    headers: { "Accept": "text/html,*/*" },
    cache: "no-store",
  });
  if(!res.ok){
    throw new Error(`HTTP ${res.status} ${res.statusText}`);
  }
  return await res.text();
}


  async function calc(){
    const raw = htmlInput.value;

    if(looksLikeUrl(raw)){
      try{
        setStatus("warn", "URLã‹ã‚‰HTMLå–å¾—ä¸­â€¦ï¼ˆCORSã§å¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰");
        const html = await fetchHtmlFromUrl(raw);
        raw = html;
        toast("URLã‹ã‚‰HTMLã‚’å–å¾—ã—ã¾ã—ãŸã€‚è§£æã—ã¾ã™ã€‚", "ok");
      }catch(e){
console.log(raw);
      }
    }


    if(!raw || raw.trim().length < 100){
      toast("HTMLãŒç©ºã§ã™ã€‚å‡ºé¦¬è¡¨HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚", "warn");
      setStatus("warn", "å…¥åŠ›ä¸è¶³");
      return;
    }

    btnCalc.disabled = true;
    try{
      const horses = parseOddsParkRaceHTML(raw);
      lastData = enrichStats(horses);

      // quick sanity
      const okCount = lastData.filter(h=>h._best!=null).length;
      const total = lastData.length;

      render();

      if(okCount === 0){
        setStatus("bad", `æŠ½å‡ºã¯ã§ãã¾ã—ãŸãŒæŒ‡æ•°ãŒç®—å‡ºã§ãã¾ã›ã‚“ï¼ˆè·é›¢/ã‚¿ã‚¤ãƒ æŠ½å‡ºå¤±æ•—ã®å¯èƒ½æ€§ï¼‰: ${total}é ­`);
        toast("æŒ‡æ•°ãŒç®—å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚HTMLã®å½¢å¼ï¼ˆãƒšãƒ¼ã‚¸ã‚½ãƒ¼ã‚¹ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "bad");
      }else{
        setStatus("ok", `è§£æå®Œäº†: ${total}é ­ï¼ˆæŒ‡æ•°ç®—å‡º: ${okCount}é ­ï¼‰`);
        toast(`è§£æå®Œäº†ï¼š${total}é ­ï¼ˆç®—å‡ºï¼š${okCount}é ­ï¼‰`, "ok");
      }
    }catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="6" class="muted">è§£æã‚¨ãƒ©ãƒ¼: ${escapeHtml(e.message || String(e))}</td></tr>`;
      setStatus("bad", "è§£æã‚¨ãƒ©ãƒ¼");
      toast("è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚½ãƒ¼ã‚¹å…¨ä½“ã‚’è²¼ã‚Šä»˜ã‘ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "bad");
    }finally{
      btnCalc.disabled = false;
    }
  }

  function clearAll(){
    htmlInput.value = "";
    lastData = [];
    q.value = "";
    sort.value = "bestAsc";
    tbody.innerHTML = `<tr><td colspan="6" class="muted">ã¾ã çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã§HTMLã‚’è²¼ã‚Šä»˜ã‘ã¦ï¼»æŒ‡æ•°ã‚’å‡ºã™ï¼½ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</td></tr>`;
    setStatus("", "æœªè§£æ");
    toast("ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚", "ok");
  }

  // events
  btnPaste.addEventListener("click", pasteFromClipboard);
  btnCalc.addEventListener("click", calc);
  btnClear.addEventListener("click", clearAll);
  q.addEventListener("input", render);
  sort.addEventListener("change", render);

  // convenient hotkeys
  window.addEventListener("keydown", (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="enter"){
      e.preventDefault();
      calc();
    }
  });

})();
</script>
</body>
</html>
