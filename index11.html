<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>招待隠蔽・感染ゲーム（スマホ回し）</title>
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --text:#eef0ff; --muted:#aab0d6;
      --accent:#6ee7ff; --danger:#ff6b6b; --ok:#7CFF9B; --btn:#23264a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #1c2150 0%, var(--bg) 55%, #0b0d18 100%);
      color:var(--text);
      min-height:100dvh;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .app{width:min(720px, 100%); display:flex; flex-direction:column; gap:14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background: rgba(0,0,0,.18);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header .title{font-weight:800; letter-spacing:.02em}
    header .meta{color:var(--muted); font-size:13px}
    .content{padding:18px; display:flex; flex-direction:column; gap:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      font-size:13px; color:var(--muted);
    }
    .pill b{color:var(--text)}
    .btn{
      appearance:none; border:none; border-radius: 14px;
      background: var(--btn); color:var(--text);
      padding:12px 14px; font-weight:700; cursor:pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      transition: transform .04s ease, filter .12s ease;
      flex: 1 1 220px;
    }
    .btn:active{transform: translateY(1px); filter:brightness(.95)}
    .btn.primary{background: linear-gradient(135deg, rgba(110,231,255,.22), rgba(110,231,255,.08)), var(--btn); border-color: rgba(110,231,255,.25)}
    .btn.danger{background: linear-gradient(135deg, rgba(255,107,107,.22), rgba(255,107,107,.08)), var(--btn); border-color: rgba(255,107,107,.25)}
    .btn.ok{background: linear-gradient(135deg, rgba(124,255,155,.18), rgba(124,255,155,.06)), var(--btn); border-color: rgba(124,255,155,.22)}
    .btn.ghost{
      background: transparent;
      border:1px dashed rgba(255,255,255,.22);
      box-shadow:none;
      color: var(--muted);
    }
    .big{
      font-size:22px; font-weight:900; letter-spacing:.01em;
      line-height:1.25;
    }
    .muted{color:var(--muted); line-height:1.65}
    .panel{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding:14px;
    }
    .list{display:grid; grid-template-columns: 1fr; gap:10px;}
    .playerRow{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.07);
      gap:10px;
    }
    .tag{
      font-size:12px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .tag.inf{border-color: rgba(255,107,107,.35); background: rgba(255,107,107,.10); color:#ffd1d1}
    .tag.safe{border-color: rgba(124,255,155,.25); background: rgba(124,255,155,.08); color:#d6ffe1}
    .hr{height:1px; background: rgba(255,255,255,.10); margin:6px 0;}
    .mono{font-variant-numeric: tabular-nums;}
    .footerNote{font-size:12px; color:var(--muted)}
    input[type="number"]{
      width: 160px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    @media (max-width:420px){
      .btn{flex-basis: 100%;}
      input[type="number"]{width: 100%;}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <div class="title">招待隠蔽・感染ゲーム（スマホ回し）</div>
          <div class="meta">リアルタイムで話し合いながら進行 / 端末を回して各自が行動</div>
        </div>
        <div class="pill"><span>ラウンド</span> <b class="mono" id="roundLabel">-</b></div>
      </header>

      <div class="content" id="view"></div>
    </div>

    <div class="card">
      <div class="content">
        <div class="row">
          <button class="btn ghost" id="btnRules">ルール表示</button>
          <button class="btn ghost" id="btnReset">最初から</button>
        </div>
        <div class="footerNote">
          ※ 画面に「スマホを渡して…」と出たら、その人以外は見ないで回してください。<br/>
          ※ リザルトでは感染状況が全員分見えます（公開情報として扱ってください）。
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== 状態 ======
  const S = {
    phase: "setup", // setup | infectPhase | pass | action | healSelect | actionResult | roundOver | results
    n: 0,
    round: 1,
    currentPlayer: 1, // 1..n
    infected: [],     // boolean length n (0-index)
    score: [],        // number length n
    resultTitle: "",
    resultBody: "",
    pending: null,    // pass画面から次に進む先
    resultReason: ""
  };

  const elView = document.getElementById("view");
  const elRound = document.getElementById("roundLabel");

  // ====== ユーティリティ ======
  const rndi = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

  function nonInfectedIndices(){
    const a=[];
    for(let i=0;i<S.n;i++) if(!S.infected[i]) a.push(i);
    return a;
  }
  function allInfected(){ return S.infected.every(Boolean); }
  function countInfected(){ return S.infected.filter(Boolean).length; }

  function setPhase(p){
    S.phase = p;
    render();
  }

  function clampScores(){
    // 仕様外だが見やすさのため0下限
    for(let i=0;i<S.n;i++){
      if(S.score[i] < 0) S.score[i] = 0;
    }
  }

  // 行動後：感染者全員が +5 点
  function grantInfectedBonus(){
    for(let i=0;i<S.n;i++){
      if(S.infected[i]) S.score[i] += 5;
    }
  }

  // ====== ゲーム進行 ======
  function startNewGame(n){
    S.n = n;
    S.round = 1;
    S.currentPlayer = 1;
    S.infected = Array(n).fill(false);
    S.score = Array(n).fill(0);
    S.resultTitle = "";
    S.resultBody = "";
    S.pending = null;
    S.resultReason = "";
    setPhase("infectPhase");
  }

  function beginInfectionPhase(){
    // 感染フェイズ：非感染者から1人ランダム感染（自動）
    const non = nonInfectedIndices();
    if(non.length === 0){
      finishRoundAllInfected();
      return;
    }
    const idx = non[rndi(0, non.length-1)];
    S.infected[idx] = true;

    if(countInfected() > S.n / 2){
      finishRoundAllInfected();
    }else{
      S.currentPlayer = 1;
      showPassScreen("action");
    }
  }

  function showPassScreen(next){
    S.pending = next; // "action"
    setPhase("pass");
  }

  function goNextAfterResult(){
    if(S.currentPlayer < S.n){
      S.currentPlayer += 1;
      showPassScreen("action");
    }else{
      S.round += 1;
      setPhase("infectPhase");
    }
  }

  function showActionResult(title, body){
    S.resultTitle = title;
    S.resultBody = body;
    setPhase("actionResult");
  }

  function doInfectionCheck(playerIndex){
    // 感染チェック：自分以外をランダムで1人チェックし、「感染者か」を知る
    const candidates = [];
    for(let i=0;i<S.n;i++){
      if(i !== playerIndex) candidates.push(i);
    }
    const t = candidates[rndi(0, candidates.length-1)];
    const isInf = S.infected[t];

    // 行動後ボーナス：感染者全員 +5
    grantInfectedBonus();
    clampScores();

    // 結果表示（このプレイヤーだけが見て次へ）
    showActionResult(
      "感染チェック結果",
      `プレイヤー${t+1} は ${isInf ? "感染者です" : "感染者ではありません"}。`
    );
  }

  function openHealSelect(playerIndex){
    // 治す：対象プレイヤーを選択
    setPhase("healSelect");
  }

  function doHeal(playerIndex, targetIndex){
    // 治す：表示コメントは「プレイヤー○を治しました」のみ
    // 内部処理は従来ルール通り（対象が感染者か否かで減点/治癒処理）

    if(!S.infected[targetIndex]){
      // 対象が感染者でない → 非感染者全員 -3
      for(let i=0;i<S.n;i++){
        if(!S.infected[i]) S.score[i] -= 3;
      }
    }else{
      // 対象が感染者 → 対象は非感染者になる／対象＋（治療時点の）感染者全員 -5
      const infectedBefore = S.infected.slice();
      for(let i=0;i<S.n;i++){
        if(infectedBefore[i]) S.score[i] -= 5;
      }
      S.infected[targetIndex] = false;
    }

    // 行動後ボーナス：感染者全員 +5（治療で感染者が減っている場合は「治療後の感染者」へ付与）
    grantInfectedBonus();
    clampScores();

    // 結果表示（詳細は伏せる）
    showActionResult(
      "治療しました",
      `プレイヤー${targetIndex+1} を治しました。`
    );
  }

  function finishRoundAllInfected(){
    S.resultReason = "全員が感染しました。全員感染したため、全員治療されました。";
    setPhase("roundOver");
  }

  function goToResults(){ setPhase("results"); }

  function continueGameCarryScore(){
    // 点数引き継ぎで続ける：感染状況だけリセット
    S.infected = Array(S.n).fill(false);
    S.currentPlayer = 1;
    S.resultTitle = "";
    S.resultBody = "";
    S.resultReason = "";
    setPhase("infectPhase");
  }

  function restartAll(){
    S.phase = "setup";
    S.n = 0;
    S.round = 1;
    S.currentPlayer = 1;
    S.infected = [];
    S.score = [];
    S.resultTitle = "";
    S.resultBody = "";
    S.pending = null;
    S.resultReason = "";
    render();
  }

  // ====== 画面レンダリング ======
  function render(){
    elRound.textContent = (S.phase === "setup") ? "-" : String(S.round);

    if(S.phase === "setup"){
      elView.innerHTML = `
        <div class="big">最初にプレイ人数を決めてください</div>
        <div class="muted">※ 2人以上推奨</div>
        <div class="panel">
          <div class="row">
            <div class="pill"><span>人数</span> <b>2〜30</b></div>
          </div>
          <div class="row">
            <input id="numPlayers" type="number" min="2" max="30" step="1" value="5" />
            <button class="btn primary" id="btnStart">ゲーム開始</button>
          </div>
          <div class="muted" style="margin-top:10px">
            進行：<b>感染フェイズ（自動）→ 行動フェイズ（全員1回ずつ）→ …</b><br/>
            行動後：<b>感染者全員が+5点</b> を得ます。
          </div>
        </div>
      `;
      document.getElementById("btnStart").onclick = () => {
        const n = Math.max(2, Math.min(30, Number(document.getElementById("numPlayers").value || 0)));
        startNewGame(n);
      };
      return;
    }

    if(S.phase === "infectPhase"){
      elView.innerHTML = `
        <div class="big">感染フェイズ</div>
        <div class="muted">非感染者から <b>1人</b> をランダムで感染させます（自動）。</div>
        <div class="panel">
          <div class="row">
            <div class="pill">感染者 <b class="mono">${countInfected()}</b> / <b class="mono">${S.n}</b></div>
            <div class="pill">非感染者 <b class="mono">${S.n - countInfected()}</b></div>
          </div>
          <div class="hr"></div>
          <button class="btn primary" id="btnAutoInfect">感染（自動実行）</button>
          <div class="muted" style="margin-top:10px">話し合いの準備ができたら押してください。</div>
        </div>
      `;
      document.getElementById("btnAutoInfect").onclick = beginInfectionPhase;
      return;
    }

    if(S.phase === "pass"){
      const p = S.currentPlayer;
      elView.innerHTML = `
        <div class="big">スマホを回してください</div>
        <div class="panel">
          <div class="big" style="font-size:20px">プレイヤー${p} がボタンを押してください</div>
          <div class="muted">※ 他の人は見ないで渡してください</div>
          <div class="hr"></div>
          <button class="btn primary" id="btnImPlayer">プレイヤー${p}です</button>
        </div>
      `;
      document.getElementById("btnImPlayer").onclick = () => {
        if(S.pending === "action") setPhase("action");
        else setPhase("action");
      };
      return;
    }

    if(S.phase === "action"){
      const i = S.currentPlayer - 1;
      const isInf = S.infected[i];

      elView.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div class="big">行動フェイズ：プレイヤー${i+1}</div>
          ${isInf ? `<span class="tag inf">感染者</span>` : `<span class="tag safe">非感染者</span>`}
        </div>
        <div class="muted">
          ${isInf
            ? "あなたは <b>感染者</b> です。<b>感染チェック</b> のみできます。"
            : "あなたは <b>非感染者</b> です。<b>感染チェック</b> か <b>治す</b> を選べます（治療対象は選択）。"}
        </div>

        <div class="panel">
          <div class="row">
            <button class="btn danger" id="btnCheck">感染チェック</button>
            ${isInf ? "" : `<button class="btn ok" id="btnHeal">治す</button>`}
          </div>
          <div class="hr"></div>
          <div class="muted">
            行動後：<b>感染者全員が+5点</b>
          </div>
        </div>

        <div class="panel">
          <div class="row">
            <div class="pill">感染者 <b class="mono">${countInfected()}</b> / <b class="mono">${S.n}</b></div>
            <div class="pill">順番 <b class="mono">${S.currentPlayer}</b> / <b class="mono">${S.n}</b></div>
          </div>
        </div>
      `;

      document.getElementById("btnCheck").onclick = () => doInfectionCheck(i);
      if(!isInf){
        document.getElementById("btnHeal").onclick = () => openHealSelect(i);
      }
      return;
    }

    if(S.phase === "healSelect"){
      const i = S.currentPlayer - 1;

      const buttons = [];
      for(let t=0;t<S.n;t++){
        if(t === i) continue;
        buttons.push(`<button class="btn ok" data-t="${t}">プレイヤー${t+1} を治す</button>`);
      }

      elView.innerHTML = `
        <div class="big">治療対象を選んでください</div>
        <div class="muted">（あなたはプレイヤー${i+1}）</div>
        <div class="panel">
          <div class="row">
            ${buttons.join("")}
          </div>
          <div class="hr"></div>
          <button class="btn ghost" id="btnBack">戻る</button>
        </div>
      `;

      elView.querySelectorAll("button[data-t]").forEach(btn => {
        btn.onclick = () => {
          const t = Number(btn.getAttribute("data-t"));
          doHeal(i, t);
        };
      });
      document.getElementById("btnBack").onclick = () => setPhase("action");
      return;
    }

    if(S.phase === "actionResult"){
      elView.innerHTML = `
        <div class="big">${escapeHtml(S.resultTitle)}</div>
        <div class="panel">
          <div class="big" style="font-size:20px; white-space:pre-line">${escapeHtml(S.resultBody)}</div>
          <div class="hr"></div>
          <button class="btn primary" id="btnNext">次のプレイヤーへ</button>
        </div>
        <div class="muted">
          ※ この画面を見たら、スマホを次の人へ渡してください。
        </div>
      `;
      document.getElementById("btnNext").onclick = goNextAfterResult;
      return;
    }

    if(S.phase === "roundOver"){
      elView.innerHTML = `
        <div class="big">ラウンド終了</div>
        <div class="panel">
          <div class="big" style="font-size:20px">${escapeHtml(S.resultReason)}</div>
          <div class="muted" style="margin-top:10px">
            次の画面でリザルト（点数・最終感染状況）を表示します。
          </div>
          <div class="hr"></div>
          <button class="btn primary" id="btnToResults">リザルトへ</button>
        </div>
      `;
      document.getElementById("btnToResults").onclick = goToResults;
      return;
    }

    if(S.phase === "results"){
      const rows = S.score
        .map((sc, idx) => ({ idx, sc, inf: S.infected[idx] }))
        .sort((a,b) => b.sc - a.sc);

      const listHtml = rows.map(r => `
        <div class="playerRow">
          <div style="display:flex; align-items:center; gap:10px;">
            <b>プレイヤー${r.idx+1}</b>
            ${r.inf ? `<span class="tag inf">感染</span>` : `<span class="tag safe">非感染</span>`}
          </div>
          <div class="mono" style="font-weight:900; font-size:18px">${r.sc}点</div>
        </div>
      `).join("");

      elView.innerHTML = `
        <div class="big">リザルト</div>
        <div class="muted">続けると点数を引き継いで次ラウンドへ（感染状況はリセット）。</div>

        <div class="panel">
          <div class="row">
            <div class="pill">人数 <b class="mono">${S.n}</b></div>
            <div class="pill">到達ラウンド <b class="mono">${S.round}</b></div>
          </div>
          <div class="hr"></div>
          <div class="list">
            ${listHtml}
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="btnContinue">続ける（点数引き継ぎ）</button>
          <button class="btn ghost" id="btnRestart">最初から（点数リセット）</button>
        </div>
      `;

      document.getElementById("btnContinue").onclick = continueGameCarryScore;
      document.getElementById("btnRestart").onclick = restartAll;
      return;
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // ====== ルール表示 ======
  function showRules(){
    const rules = `
【進行】
1) 人数決定
2) 感染フェイズ：非感染者から1人ランダム感染（自動）
3) 全員感染したら「全員治療されました」→ リザルト（続けるで点数引き継ぎ）
4) 非感染者がいるなら行動フェイズへ
5) 行動フェイズ：プレイヤー1→2→…→N が1回ずつ行動（スマホを回す）
6) 行動後：感染者全員が+5点
7) 全員が行動したら次の感染フェイズへ

【行動】
● 感染チェック：
- 対象は自分以外からランダム
- チェック後、対象が「感染者か」を知る

● 治す（非感染者のみ）：
- 対象プレイヤーを選択
- 表示コメントは「プレイヤー○を治しました」のみ（成否や詳細は表示しない）
- 内部処理（点数/感染状態）はルール通りに実行
   - 対象が非感染者：非感染者全員 -3点
   - 対象が感染者：対象は非感染者へ／（治療時点の）感染者全員 -5点

● 感染者は感染チェックのみ
`.trim();
    alert(rules);
  }

  document.getElementById("btnRules").onclick = showRules;
  document.getElementById("btnReset").onclick = restartAll;

  render();
})();
</script>
</body>
</html>
