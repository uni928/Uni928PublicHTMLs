<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ›ãƒ­ã‚«é¢¨ ãƒ©ã‚¤ãƒ•ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a3a;
      --stroke:#ffffff1a;
      --stroke2:#ffffff2b;
      --text:#eaf0ff;
      --muted:#b9c3e6;
      --good:#7cf7d3;
      --bad:#ff7aa2;
      --accent:#8aa7ff;
      --accent2:#b18cff;
      --pink:#ff63c3;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --ui-scale: 0.9;
    }


    /* âœ… S1 / S2 ã‚’ç¸¦ä¸¦ã³ */
    .pillCol{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-start;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 15% 20%, rgba(138,167,255,.35), transparent 55%),
        radial-gradient(900px 500px at 85% 15%, rgba(177,140,255,.25), transparent 60%),
        radial-gradient(900px 650px at 60% 85%, rgba(124,247,211,.18), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100vh;
      overflow-x:hidden;
    }

    @media (max-width: 1200px){ :root{ --ui-scale: 0.85; } }
    @media (max-width: 900px){  :root{ --ui-scale: 0.8; } }
    @media (max-width: 600px){  :root{ --ui-scale: 0.75; } }

    .wrap{
      max-width: 1280px;
      margin: 0 0;
      padding: 0;
      display:flex;
      flex-direction:column;
      gap:12px;
      transform: scale(var(--ui-scale));
      transform-origin: top center;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin: 16px 14px 0;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size:18px; letter-spacing:.04em; font-weight:1000; line-height:1.2; }
    .subtitle{ margin:0; font-size:12px; color:var(--muted); line-height:1.4; }

    .toolbar{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }

    .btn{
      border:1px solid var(--stroke2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color: var(--text);
      padding:8px 10px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      cursor:pointer;
      font-weight: 1000;
      font-size: 12px;
      letter-spacing:.03em;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter:saturate(1.1); }
    .btn:hover{ border-color: rgba(255,255,255,.35); }
    .btnPrimary{
      border-color: rgba(138,167,255,.45);
      background: linear-gradient(180deg, rgba(138,167,255,.22), rgba(138,167,255,.08));
    }
    .btnDanger{
      border-color: rgba(255,122,162,.45);
      background: linear-gradient(180deg, rgba(255,122,162,.22), rgba(255,122,162,.07));
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight: 1000;
      font-size: 12px;
      white-space:nowrap;
    }
    .chip b{ font-variant-numeric: tabular-nums; }

    .columnsStack{
      margin: 0 14px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-rows: repeat(2, minmax(0, 1fr));
      gap:14px;
      align-items:stretch;
    }

    .panel{
      border:1px solid var(--stroke);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHead{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(90deg, rgba(138,167,255,.16), rgba(177,140,255,.10));
      gap:10px;
    }
    .panelHead .label{
      font-weight: 1000;
      font-size: 12px;
      color: rgba(255,255,255,.92);
      letter-spacing:.07em;
      text-transform: uppercase;
    }
    .panelHead .hint{
      font-size: 11px;
      color: rgba(255,255,255,.70);
      letter-spacing:.02em;
      white-space:nowrap;
    }

    /* 3æ å›ºå®š */
    .rowCards{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      overflow:hidden;
      align-content:start;
    }

    /* ====== ã‚«ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥ç‰ˆï¼šæ•°å€¤ + Func ã®ã¿ï¼‰ ====== */
    .card{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background:
        radial-gradient(400px 200px at 25% 0%, rgba(138,167,255,.18), transparent 50%),
        radial-gradient(300px 180px at 90% 10%, rgba(177,140,255,.14), transparent 55%),
        linear-gradient(180deg, rgba(18,26,51,.85), rgba(12,16,33,.72));
      box-shadow: 0 14px 36px rgba(0,0,0,.30);
      position:relative;
      overflow:hidden;
      min-height: 108px;
      display:flex;
      flex-direction:column;
    }

    .badge{
      position:absolute;
      top:10px; right:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,.25);
      font-weight: 1000;
      font-size: 12px;
      letter-spacing:.03em;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      box-shadow: 0 0 18px rgba(138,167,255,.35);
    }

    .cardInner{
      padding: 36px 10px 10px; /* å°‘ã—è©°ã‚ã‚‹ */
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
      min-height:0;
    }

    .valueRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .value{
      font-size: 28px;
      line-height: 1.05;
      font-weight: 1000;
      letter-spacing:.02em;
      text-shadow: 0 10px 28px rgba(0,0,0,.35);
      user-select:none;
      cursor:pointer;
      flex:1;
      min-width:0;
margin-top:10px; /* âœ… ãƒ©ã‚¤ãƒ•æ•°å€¤ã‚’ä¸‹ã«10px */
    }

    .funcBtn{
      border:1px solid rgba(255,255,255,.20);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      color: rgba(255,255,255,.95);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 1000;
      font-size: 12px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .funcBtn:hover{ border-color: rgba(255,255,255,.35); }
    .funcBtn:active{ transform: translateY(1px); }

    /* çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆã‚¹ã‚­ãƒ«ONãªã©ï¼‰ */
    .statusLine{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      color: rgba(255,255,255,.70);
      font-size: 10px;
      letter-spacing:.02em;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight: 900;
    }
    .pill.on{
      border-color: rgba(255, 99, 195, .55);
      background: rgba(255, 99, 195, .12);
    }

    .footerNote{
      margin: 0 14px 14px;
      color: rgba(255,255,255,.70);
      font-size: 11px;
      line-height:1.5;
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,.20);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
    }

    /* ====== ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ãƒ¼ãƒ‰ç·¨é›†ï¼‰ ====== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(800px 400px at 20% 0%, rgba(138,167,255,.20), transparent 60%),
        linear-gradient(180deg, rgba(18,26,51,.92), rgba(9,12,24,.88));
      box-shadow: 0 22px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.12);
      gap:10px;
    }
    .modalTitle{
      font-weight: 1000;
      letter-spacing:.05em;
      font-size: 13px;
      color: rgba(255,255,255,.95);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modalBody{ padding: 14px; display:flex; flex-direction:column; gap:12px; }
    .modalFoot{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }

    .bigValue{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .bigValue .num{
      font-size: 40px;
      font-weight: 1000;
      letter-spacing:.03em;
      text-shadow: 0 10px 24px rgba(0,0,0,.35);
      cursor:pointer;
      user-select:none;
    }
    .deltaPill{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      padding: 6px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 108px;
      justify-content:center;
    }
    .deltaSign{ font-weight: 1000; opacity:.95; }
    .deltaNum{ font-variant-numeric: tabular-nums; }

    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      width:100%;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(255,122,162,.32),
        rgba(255,255,255,.14),
        rgba(124,247,211,.32)
      );
      outline:none;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 2px 10px rgba(0,0,0,.25);
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width: 16px; height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.35);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.25));
      box-shadow: 0 12px 24px rgba(0,0,0,.35);
      cursor:grab;
    }
    input[type="range"]::-webkit-slider-thumb:active{ cursor:grabbing; }

    .skillBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      color: rgba(255,255,255,.92);
      font-weight: 1000;
      font-size: 12px;
      letter-spacing:.03em;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
      transition: transform .12s ease, border-color .12s ease, filter .12s ease;
    }
    .skillBtn:active{ transform: translateY(1px) scale(.99); }
    .skillBtn:hover{ border-color: rgba(255,255,255,.35); }

    .skillBtn.on{
      border-color: rgba(255, 99, 195, .65);
      background: linear-gradient(180deg, rgba(255, 99, 195, .30), rgba(255, 99, 195, .10));
      box-shadow: 0 12px 28px rgba(255, 99, 195, .12);
    }
    .skillBtn.off{
      border-color: rgba(154,163,178,.45);
      background: linear-gradient(180deg, rgba(154,163,178,.18), rgba(154,163,178,.06));
      color: rgba(255,255,255,.85);
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .histBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 10px;
    }
    .histHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size: 11px; color: rgba(255,255,255,.70); font-weight: 900;
      margin-bottom: 8px;
    }
    .histItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-size: 12px; color: rgba(255,255,255,.86);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding: 8px 2px;
    }
    .histItem:last-child{ border-bottom:0; }
    .histItem b{ font-variant-numeric: tabular-nums; }

    /* Dice modalï¼ˆæ—¢å­˜ï¼‰ */
    .diceBack{ z-index: 90; }
    .diceModal{ width:min(560px, 100%); }

    /* âœ… ã‚«ãƒ¼ãƒ‰12æšã‚’ä¸€ç”»é¢ã§è¦‹ã›ã‚„ã™ã„ã‚°ãƒªãƒƒãƒ‰ */
    .allGrid{
      margin: 0 14px;
      padding: 10px;
      border: 1px solid var(--stroke);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* âœ… æœ€å¤§4åˆ— */
      gap: 12px;
      overflow: hidden;
    }

    @media (max-width: 900px){
      .allGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 600px){
      .allGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ãƒ©ã‚¤ãƒ•ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒ›ãƒ­ã‚«é¢¨ï¼‰</h1>
        <p class="subtitle">æ ã‚’æŠ¼ã™ã¨ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã™ã€‚çŠ¶æ…‹ã¯IndexedDBã«ä¿å­˜ã—ã€æ¬¡å›å¾©å¸°ã—ã¾ã™ã€‚</p>
      </div>
      <div class="toolbar">
        <span class="chip">TURN <b id="turnNum">1</b></span>
        <button class="btn btnPrimary" id="turnBtn">ã‚¿ãƒ¼ãƒ³å¤‰æ›´</button>
        <button class="btn" id="diceBtn">ğŸ² ã‚µã‚¤ã‚³ãƒ­</button>
        <button class="btn btnDanger" id="resetAll">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </header>

<div class="allGrid" id="all"></div>

    <div class="footerNote">
      æ“ä½œï¼šå„æ ã‚’æŠ¼ã™ã¨ç·¨é›†ã‚’é–‹ã â†’ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆ10åˆ»ã¿ï¼‰ã§å¢—æ¸›ã€Undoï¼ˆå±¥æ­´ãŒã‚ã‚‹é™ã‚Šä½•å›ã§ã‚‚ï¼‰ã€Cã§ãã®æ ã‚’ãƒªã‚»ãƒƒãƒˆã€‚ã‚¿ãƒ¼ãƒ³å¤‰æ›´ã§å…¨ã‚¹ã‚­ãƒ«OFFã€‚å…¨ãƒªã‚»ãƒƒãƒˆã§IndexedDBå‰Šé™¤ã€‚
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒ‰ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modalBack" id="editBack" role="dialog" aria-modal="true" aria-label="ã‚«ãƒ¼ãƒ‰ç·¨é›†">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle">
          <span>ğŸ› ï¸ ç·¨é›†</span>
          <span class="pill" id="editLabel">-</span>
        </div>
        <button class="btn" id="editClose">é–‰ã˜ã‚‹</button>
      </div>

      <div class="modalBody">
        <div class="bigValue">
          <div>
            <div style="font-size:11px;color:rgba(255,255,255,.70);font-weight:900;letter-spacing:.03em">ç¾åœ¨å€¤ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ç›´æ¥å…¥åŠ›ï¼‰</div>
            <div class="num" id="editValue">0</div>
          </div>
          <div class="deltaPill">
            <span class="deltaSign" id="editDs">Â±</span>
            <span class="deltaNum" id="editDn">0</span>
          </div>
        </div>

        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;color:rgba(255,255,255,.70);font-size:11px;font-weight:900">
            <span>-60</span><span>å·®åˆ†ï¼ˆ10åˆ»ã¿ / é›¢ã™ã¨åŠ ç®—ï¼‰</span><span>+60</span>
          </div>
          <input id="editRange" type="range" min="-60" max="60" step="10" value="0" />
        </div>

        <div class="row2">
          <button class="skillBtn off" id="editS1">ã‚¹ã‚­ãƒ«1</button>
          <button class="skillBtn off" id="editS2">ã‚¹ã‚­ãƒ«2</button>
          <button class="skillBtn" id="editUndo">Undoï¼ˆæˆ»ã™ï¼‰</button>
          <button class="skillBtn" id="editReset">Cï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</button>
        </div>

        <div class="histBox">
          <div class="histHead">
            <span id="histCount" style="color:rgba(255,255,255,.60);font-size:11px">0ä»¶</span>
          </div>
          <div id="editHist"></div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="editSaveNow">ä»Šã™ãä¿å­˜</button>
        <button class="btn btnDanger" id="editClose2">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Dice Modal -->
  <div class="modalBack diceBack" id="modalBack" role="dialog" aria-modal="true" aria-label="ã‚µã‚¤ã‚³ãƒ­">
    <div class="modal diceModal">
      <div class="modalHead">
        <div class="modalTitle">ğŸ² ã‚µã‚¤ã‚³ãƒ­ï¼ˆå±¥æ­´è¡¨ç¤ºï¼‰</div>
        <button class="btn" id="closeModal">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody">
        <div class="bigValue" style="padding:14px">
          <div>
            <div style="font-size:12px;color:rgba(255,255,255,.70);font-weight:900;letter-spacing:.03em">æœ€æ–°ã®ç›®</div>
            <div class="num" id="diceNum">-</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
            <button class="btn btnPrimary" id="rollBtn">æŒ¯ã‚‹</button>
            <button class="btn btnDanger" id="clearDice">å±¥æ­´ã‚¯ãƒªã‚¢</button>
          </div>
        </div>

        <div class="histBox">
          <div class="histHead">
            <span>å±¥æ­´</span>
            <span style="color:rgba(255,255,255,.60);font-size:11px">æœ€å¤§ 30 ä»¶</span>
          </div>
          <div id="hist"></div>
        </div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="copyHist">å±¥æ­´ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // IndexedDB æ°¸ç¶šåŒ–ï¼ˆå¾©å¸°ã‚ã‚Šï¼‰
    // =========================
    const DB_NAME = "holoca_life_counter_db";
    const DB_VER  = 1;
    const STORE   = "kv";
    const STATE_KEY = "state";

    let _dbPromise = null;
    function openDB(){
      if (_dbPromise) return _dbPromise;
      _dbPromise = new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE)){
            db.createObjectStore(STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      return _dbPromise;
    }

    async function idbGet(key){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const st = tx.objectStore(STORE);
        const req = st.get(key);
        req.onsuccess = () => resolve(req.result ?? null);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbSet(key, val){
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const st = tx.objectStore(STORE);
        const req = st.put(val, key);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    async function deleteDB(){
      try{
        const db = await openDB();
        db.close();
      }catch{}
      _dbPromise = null;
      return new Promise((resolve, reject) => {
        const req = indexedDB.deleteDatabase(DB_NAME);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
        req.onblocked = () => resolve(true);
      });
    }

    function snapshotState(){
      const dice = diceHistory.map(x => ({ t: x.t instanceof Date ? x.t.getTime() : x.t, v: x.v })).slice(0, 30);
      return {
        v: 1,
        turn,
        values,
        skills,
        deltaHist,
        diceHistory: dice,
      };
    }

    let _saveTimer = null;
    function scheduleSave(){
      if (_saveTimer) clearTimeout(_saveTimer);
      _saveTimer = setTimeout(async () => {
        try{ await idbSet(STATE_KEY, snapshotState()); }
        catch(e){ console.warn("IndexedDB save failed:", e); }
      }, 200);
    }
    async function saveNow(){
      try{ await idbSet(STATE_KEY, snapshotState()); }
      catch(e){ console.warn("IndexedDB saveNow failed:", e); }
    }

    // =========================
    // ã‚¢ãƒ—ãƒªæœ¬ä½“
    // =========================
    // âœ… å…¨ã‚«ãƒ¼ãƒ‰ã‚’1ã‚³ãƒ³ãƒ†ãƒŠã«ä¸¦ã¹ã‚‹
    const layout = [
      { count: 3, prefix: "StageA" },
      { count: 3, prefix: "æ¨ã—A" },
      { count: 3, prefix: "æ¨ã—B" },
      { count: 3, prefix: "StageB" },
    ];

    const values = Object.create(null);
    const skills = Object.create(null);
    const deltaHist = Object.create(null); // ç„¡åˆ¶é™ï¼ˆè¡¨ç¤ºã¯ç›´è¿‘3ï¼‰
    let turn = 1;

    const diceHistory = []; // {t: Date, v: number}

    function applySkillBtnClass(btn, on){
      btn.classList.toggle("on", !!on);
      btn.classList.toggle("off", !on);
    }

    function setAllSkillsOff(){
      for (const id of Object.keys(skills)){
        skills[id].s1 = false;
        skills[id].s2 = false;
      }
      // ã‚«ãƒ¼ãƒ‰å´ã®è¡¨ç¤ºã‚‚æ›´æ–°
      document.querySelectorAll(".card").forEach(card => {
        const id = card.dataset.id;
        renderCardStatus(id);
      });
      // ç·¨é›†ä¸­ãªã‚‰åæ˜ 
      if (currentEditId) renderEditModal();
    }

    function fmtDelta(n){
      const sign = n > 0 ? "+" : (n < 0 ? "âˆ’" : "Â±");
      const abs = Math.abs(n);
      return { sign, abs };
    }

    function pushDeltaHistory(id, delta){
      if (!deltaHist[id]) deltaHist[id] = [];
      deltaHist[id].unshift(delta); // ç„¡åˆ¶é™
    }

    function popDeltaHistory(id){
      if (!deltaHist[id] || deltaHist[id].length === 0) return null;
      return deltaHist[id].shift();
    }

    function renderCardValue(id){
      const el = document.getElementById(`${id}-value`);
      if (el) el.textContent = String(values[id] ?? 0);
    }

    function renderCardStatus(id){
      const s1 = !!(skills[id]?.s1);
      const s2 = !!(skills[id]?.s2);
      const s1El = document.getElementById(`${id}-st1`);
      const s2El = document.getElementById(`${id}-st2`);
      if (s1El){
        s1El.classList.toggle("on", s1);
        s1El.textContent = `S1:${s1 ? "ON" : "OFF"}`;
      }
      if (s2El){
        s2El.classList.toggle("on", s2);
        s2El.textContent = `S2:${s2 ? "ON" : "OFF"}`;
      }
    }

    function makeCard(id, labelText){
      if (!(id in values)) values[id] = 0;
      if (!(id in skills)) skills[id] = { s1:false, s2:false };
      if (!(id in deltaHist)) deltaHist[id] = [];

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = id;

      card.innerHTML = `
        <div class="badge"><span class="dot"></span><span>${labelText}</span></div>
        <div class="cardInner">
          <div class="valueRow">
            <div class="value" id="${id}-value" title="ã‚¯ãƒªãƒƒã‚¯ã§ç›´æ¥å…¥åŠ›">0</div>
          </div>
          <div class="statusLine">
            <div class="pillCol">
              <span class="pill" id="${id}-st1">S1:OFF</span>
              <span class="pill" id="${id}-st2">S2:OFF</span>
            </div>
            <span style="opacity:.85">Î”å±¥æ­´: <b id="${id}-hc" style="font-variant-numeric:tabular-nums">0</b></span>
          </div>
        </div>
      `;

      // ç›´æ¥å…¥åŠ›ã¯æ®‹ã™ï¼ˆå¿…è¦ãªã‘ã‚Œã°æ¶ˆã›ã¾ã™ï¼‰
      card.querySelector(`#${id}-value`).addEventListener("click", () => {
        const next = prompt("æ•°å€¤ã‚’ç›´æ¥å…¥åŠ›ï¼ˆæ•´æ•°ï¼‰", String(values[id] ?? 0));
        if (next === null) return;
        const n = Number(next);
        if (!Number.isFinite(n)) return;
        values[id] = Math.trunc(n);
        renderCardValue(id);
        scheduleSave();
        if (currentEditId === id) renderEditModal();
      });

      card.addEventListener("click", () => {
        openEdit(id, labelText);
      });

      renderCardValue(id);
      renderCardStatus(id);
      renderCardHistCount(id);
      return card;
    }

    function renderCardHistCount(id){
      const el = document.getElementById(`${id}-hc`);
      if (!el) return;
      el.textContent = String((deltaHist[id] || []).length);
    }

    function build(){
      const mount = document.getElementById("all");
      mount.innerHTML = "";
      for (const group of layout){
        for (let i=1;i<=group.count;i++){
          const id = `${group.prefix}${i}`;
          const label = `${group.prefix}-${i}`;
          mount.appendChild(makeCard(id, label));
        }
      }
    }

    // =========================
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    // =========================
    const editBack   = document.getElementById("editBack");
    const editLabel  = document.getElementById("editLabel");
    const editValue  = document.getElementById("editValue");
    const editRange  = document.getElementById("editRange");
    const editDs     = document.getElementById("editDs");
    const editDn     = document.getElementById("editDn");
    const editS1     = document.getElementById("editS1");
    const editS2     = document.getElementById("editS2");
    const editUndo   = document.getElementById("editUndo");
    const editReset  = document.getElementById("editReset");
    const editHist   = document.getElementById("editHist");
    const histCount  = document.getElementById("histCount");

    let currentEditId = null;
    let currentEditLabel = "";

    function openEdit(id, label){
      currentEditId = id;
      currentEditLabel = label;
      editRange.value = 0;
      renderEditDelta(0);
      renderEditModal();
      editBack.style.display = "flex";
    }

    function closeEdit(){
      editBack.style.display = "none";
      currentEditId = null;
      currentEditLabel = "";
    }

    function renderEditDelta(v){
      const n = Number(v) || 0;
      const { sign, abs } = fmtDelta(n);
      editDs.textContent = sign;
      editDn.textContent = abs;
      const c = n > 0 ? "var(--good)" : (n < 0 ? "var(--bad)" : "rgba(255,255,255,.85)");
      editDs.style.color = c;
      editDn.style.color = c;
    }

    function renderEditModal(){
      if (!currentEditId) return;
      const id = currentEditId;

      editLabel.textContent = currentEditLabel;
      editValue.textContent = String(values[id] ?? 0);

      // skills
      applySkillBtnClass(editS1, !!skills[id]?.s1);
      applySkillBtnClass(editS2, !!skills[id]?.s2);

      // undo enable
      const arr = deltaHist[id] || [];
      editUndo.disabled = arr.length === 0;
      editUndo.style.opacity = arr.length === 0 ? 0.55 : 1;

      // hist render (ç›´è¿‘3è¡¨ç¤º)
      //const view = arr.slice(0, 3);
      const view = arr;
      histCount.textContent = `${arr.length}ä»¶`;

      editHist.innerHTML = "";
      if (arr.length === 0){
        const div = document.createElement("div");
        div.className = "histItem";
        div.style.justifyContent = "center";
        div.style.color = "rgba(255,255,255,.62)";
        div.textContent = "å±¥æ­´ãªã—";
        editHist.appendChild(div);
      }else{
        for (const d of view){
          const sign = d > 0 ? "+" : "âˆ’";
          const row = document.createElement("div");
          row.className = "histItem";
          row.innerHTML = `<div>å·®åˆ† <b>${sign}${Math.abs(d)}</b></div><div style="color:rgba(255,255,255,.62);font-size:11px">ç›´è¿‘</div>`;
          editHist.appendChild(row);
        }
      }

      // ã‚«ãƒ¼ãƒ‰å´ã®å°è¡¨ç¤ºã‚‚æ›´æ–°
      renderCardValue(id);
      renderCardStatus(id);
      renderCardHistCount(id);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("editClose").addEventListener("click", closeEdit);
    document.getElementById("editClose2").addEventListener("click", closeEdit);
    editBack.addEventListener("click", (e) => { if (e.target === editBack) closeEdit(); });

    // ç›´æ¥å…¥åŠ›
    editValue.addEventListener("click", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      const next = prompt("æ•°å€¤ã‚’ç›´æ¥å…¥åŠ›ï¼ˆæ•´æ•°ï¼‰", String(values[id] ?? 0));
      if (next === null) return;
      const n = Number(next);
      if (!Number.isFinite(n)) return;
      values[id] = Math.trunc(n);
      scheduleSave();
      renderEditModal();
    });

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆinputã§å·®åˆ†è¡¨ç¤ºã€changeã§ç¢ºå®šï¼‰
    editRange.addEventListener("input", () => renderEditDelta(editRange.value));
    editRange.addEventListener("change", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      const delta = Number(editRange.value) || 0;
      if (delta !== 0){
        values[id] = (values[id] ?? 0) + delta;
        pushDeltaHistory(id, delta);
        scheduleSave();
      }
      editRange.value = 0;
      renderEditDelta(0);
      renderEditModal();
    });

    // ã‚¹ã‚­ãƒ«
    editS1.addEventListener("click", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      skills[id].s1 = !skills[id].s1;
      scheduleSave();
      renderEditModal();
    });
    editS2.addEventListener("click", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      skills[id].s2 = !skills[id].s2;
      scheduleSave();
      renderEditModal();
    });

    // Undoï¼ˆä½•å›ã§ã‚‚ï¼‰
    editUndo.addEventListener("click", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      const last = popDeltaHistory(id);
      if (last === null) return;
      values[id] = (values[id] ?? 0) - last;
      scheduleSave();
      renderEditModal();
    });

    // Cï¼ˆæ ãƒªã‚»ãƒƒãƒˆï¼‰
    editReset.addEventListener("click", () => {
      if (!currentEditId) return;
      const id = currentEditId;
      values[id] = 0;
      deltaHist[id] = [];
      scheduleSave();
      renderEditModal();
    });

    // ä»Šã™ãä¿å­˜
    document.getElementById("editSaveNow").addEventListener("click", async () => {
      await saveNow();
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
    });

    // =========================
    // ä¸Šéƒ¨æ©Ÿèƒ½ï¼ˆã‚¿ãƒ¼ãƒ³/å…¨ãƒªã‚»ãƒƒãƒˆ/ã‚µã‚¤ã‚³ãƒ­ï¼‰
    // =========================
    function nextTurn(){
      turn += 1;
      document.getElementById("turnNum").textContent = String(turn);
      setAllSkillsOff();
      scheduleSave();
    }

    async function resetAll(){
      // ãƒ¡ãƒ¢ãƒªä¸Šã‚’åˆæœŸåŒ–
      for (const k of Object.keys(values)) values[k] = 0;
      for (const k of Object.keys(deltaHist)) deltaHist[k] = [];
      for (const k of Object.keys(skills)) skills[k] = { s1:false, s2:false };
      turn = 1;
      diceHistory.length = 0;

      // UIåæ˜ 
      document.getElementById("turnNum").textContent = "1";
      document.querySelectorAll(".card").forEach(card => {
        const id = card.dataset.id;
        renderCardValue(id);
        renderCardStatus(id);
        renderCardHistCount(id);
      });
      renderDiceHist();
      document.getElementById("diceNum").textContent = "-";
      if (currentEditId) renderEditModal();

      // âœ… IndexedDBå‰Šé™¤
      await deleteDB().catch(e => console.warn("deleteDB failed:", e));
      alert("å…¨ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ï¼‰");
    }

    document.getElementById("turnBtn").addEventListener("click", nextTurn);
    document.getElementById("resetAll").addEventListener("click", resetAll);

    // Dice modal
    const modalBack = document.getElementById("modalBack");
    const diceNumEl = document.getElementById("diceNum");
    const histEl = document.getElementById("hist");

    function openDice(){ modalBack.style.display = "flex"; renderDiceHist(); }
    function closeDice(){ modalBack.style.display = "none"; }

    function fmtTime(d){
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function renderDiceHist(){
      histEl.innerHTML = "";
      if (diceHistory.length === 0){
        const empty = document.createElement("div");
        empty.className = "histItem";
        empty.style.justifyContent = "center";
        empty.style.color = "rgba(255,255,255,.62)";
        empty.textContent = "ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“";
        histEl.appendChild(empty);
        return;
      }
      for (const item of diceHistory){
        const row = document.createElement("div");
        row.className = "histItem";
        row.innerHTML = `<div>ğŸ² <b style="font-size:14px">${item.v}</b></div><div style="color:rgba(255,255,255,.62);font-size:11px">${fmtTime(item.t)}</div>`;
        histEl.appendChild(row);
      }
    }

    function rollDice(){
      const v = Math.floor(Math.random()*6) + 1;
      diceNumEl.textContent = String(v);
      diceHistory.unshift({ t: new Date(), v });
      if (diceHistory.length > 30) diceHistory.pop();
      renderDiceHist();
      scheduleSave();
    }

    function clearDice(){
      diceHistory.length = 0;
      diceNumEl.textContent = "-";
      renderDiceHist();
      scheduleSave();
    }

    async function copyHistory(){
      const lines = diceHistory
        .slice()
        .reverse()
        .map(x => `${fmtTime(x.t)}  ${x.v}`);
      const text = lines.join("\n") || "ï¼ˆå±¥æ­´ãªã—ï¼‰";
      try{
        await navigator.clipboard.writeText(text);
        alert("å±¥æ­´ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch{
        prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯ã“ã“ã‹ã‚‰æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„", text);
      }
    }

    document.getElementById("diceBtn").addEventListener("click", openDice);
    document.getElementById("closeModal").addEventListener("click", closeDice);
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeDice(); });
    document.getElementById("rollBtn").addEventListener("click", rollDice);
    document.getElementById("clearDice").addEventListener("click", clearDice);
    document.getElementById("copyHist").addEventListener("click", copyHistory);

    // =========================
    // èµ·å‹•æ™‚å¾©å¸° â†’ build â†’ UIåæ˜ 
    // =========================
    (async () => {
      build();

      try{
        const saved = await idbGet(STATE_KEY);
        if (saved && typeof saved === "object"){
          if (typeof saved.turn === "number") turn = saved.turn;

          if (saved.values && typeof saved.values === "object"){
            for (const k of Object.keys(saved.values)) values[k] = saved.values[k];
          }
          if (saved.skills && typeof saved.skills === "object"){
            for (const k of Object.keys(saved.skills)) skills[k] = saved.skills[k];
          }
          if (saved.deltaHist && typeof saved.deltaHist === "object"){
            for (const k of Object.keys(saved.deltaHist)) deltaHist[k] = saved.deltaHist[k];
          }
          if (Array.isArray(saved.diceHistory)){
            diceHistory.length = 0;
            for (const it of saved.diceHistory.slice(0,30)){
              diceHistory.push({ t: new Date(it.t), v: it.v });
            }
            diceHistory.sort((a,b)=>b.t - a.t);
          }
        }
      }catch(e){
        console.warn("restore failed:", e);
      }

      document.getElementById("turnNum").textContent = String(turn);

      // UIåæ˜ 
      document.querySelectorAll(".card").forEach(card => {
        const id = card.dataset.id;
        renderCardValue(id);
        renderCardStatus(id);
        renderCardHistCount(id);
      });

      renderDiceHist();
      if (diceHistory.length > 0) diceNumEl.textContent = String(diceHistory[0].v);
    })();
  </script>
</body>
</html>
