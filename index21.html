<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>参拝</title>
  <style>
    :root{
      --bg1:#fffaf0;
      --bg2:#fff2d9;
      --ink:#221c16;
      --gold:#b88a2b;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 900px at 50% 35%, rgba(255,255,255,.95) 0%, rgba(255,248,232,.85) 38%, rgba(255,238,210,.85) 65%, rgba(248,232,200,.95) 100%),
        radial-gradient(900px 650px at 50% 30%, rgba(184,138,43,.10) 0%, rgba(184,138,43,0) 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .vignette{
      position:fixed; inset:-20px;
      background:
        radial-gradient(circle at 50% 40%, rgba(0,0,0,0) 0%, rgba(0,0,0,.06) 70%, rgba(0,0,0,.10) 100%);
      pointer-events:none;
      mix-blend-mode:multiply;
    }
    .rays{
      position:fixed; inset:-20%;
      background:
        conic-gradient(from 180deg at 50% 35%,
          rgba(184,138,43,.00) 0deg,
          rgba(184,138,43,.08) 10deg,
          rgba(184,138,43,.00) 22deg,
          rgba(184,138,43,.06) 34deg,
          rgba(184,138,43,.00) 48deg,
          rgba(184,138,43,.09) 62deg,
          rgba(184,138,43,.00) 78deg,
          rgba(184,138,43,.07) 96deg,
          rgba(184,138,43,.00) 120deg,
          rgba(184,138,43,.08) 150deg,
          rgba(184,138,43,.00) 180deg,
          rgba(184,138,43,.06) 210deg,
          rgba(184,138,43,.00) 240deg,
          rgba(184,138,43,.09) 270deg,
          rgba(184,138,43,.00) 300deg,
          rgba(184,138,43,.07) 330deg,
          rgba(184,138,43,.00) 360deg
        );
      filter: blur(0.4px);
      opacity:.55;
      animation: slowspin 18s linear infinite;
      transform-origin: 50% 35%;
      pointer-events:none;
      mask-image: radial-gradient(circle at 50% 35%, rgba(0,0,0,1) 0%, rgba(0,0,0,.7) 45%, rgba(0,0,0,0) 75%);
    }
    @keyframes slowspin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    .frame{
      width:min(920px, 92vw);
      min-height: 36vh;
      display:grid;
      place-items:center;
      padding: 28px 18px;
      position:relative;
    }
    .glow{
      position:absolute; inset:-40px -40px;
      background:
        radial-gradient(380px 240px at 50% 45%, rgba(255,255,255,.95) 0%, rgba(255,255,255,.65) 30%, rgba(255,255,255,0) 70%),
        radial-gradient(560px 360px at 50% 45%, rgba(184,138,43,.20) 0%, rgba(184,138,43,0) 72%);
      filter: blur(2px);
      opacity:.9;
      pointer-events:none;
    }
    #text{
      font-family: ui-serif, "Hiragino Mincho ProN", "Yu Mincho", "Noto Serif JP", serif;
      font-size: clamp(22px, 3.2vw, 44px);
      line-height: 1.55;
      letter-spacing: .06em;
      text-align:center;
      color: var(--ink);
      text-shadow:
        0 1px 0 rgba(255,255,255,.9),
        0 10px 24px rgba(0,0,0,.10),
        0 0 22px rgba(184,138,43,.20);
      padding: 12px 10px;
      white-space: pre-line;
      user-select:none;
    }
    .spark{
      position:fixed;
      width:6px; height:6px;
      border-radius:50%;
      background: radial-gradient(circle, rgba(255,255,255,.95) 0%, rgba(184,138,43,.55) 45%, rgba(184,138,43,0) 72%);
      filter: blur(.2px);
      opacity:.85;
      pointer-events:none;
      animation: drift 7s linear infinite;
    }
    @keyframes drift{
      from{ transform: translateY(30px) translateX(0px) scale(.9); opacity:0; }
      10%{ opacity:.85; }
      to{ transform: translateY(-520px) translateX(120px) scale(1.15); opacity:0; }
    }

    @media (prefers-reduced-motion: reduce){
      .rays{ animation:none; }
      .spark{ animation:none; display:none; }
    }
  </style>
</head>
<body>
  <div class="rays" aria-hidden="true"></div>
  <div class="vignette" aria-hidden="true"></div>

  <main class="frame">
    <div class="glow" aria-hidden="true"></div>
    <div id="text" aria-live="polite"></div>
  </main>

  <script>
    const DB_NAME = "sanpai_db";
    const STORE = "kv";
    const KEY = "lastDate";

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function getValue(db, key){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const st = tx.objectStore(STORE);
        const req = st.get(key);
        req.onsuccess = () => resolve(req.result ?? null);
        req.onerror = () => reject(req.error);
      });
    }

    function setValue(db, key, value){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const st = tx.objectStore(STORE);
        const req = st.put(value, key);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    const el = document.getElementById("text");

    function setText(t){
      el.style.opacity = "0";
      el.style.filter = "blur(1px)";
      requestAnimationFrame(() => {
        el.textContent = t;
        el.style.transition = "opacity 520ms ease, filter 520ms ease";
        el.style.opacity = "1";
        el.style.filter = "blur(0px)";
      });
    }

    function spawnSparks(){
      const count = 14;
      for(let i=0;i<count;i++){
        const s = document.createElement("div");
        s.className = "spark";
        const left = Math.random()*100;
        const bottom = -20 - Math.random()*160;
        const delay = Math.random()*6;
        const dur = 6 + Math.random()*6;
        const size = 4 + Math.random()*6;
        s.style.left = left + "vw";
        s.style.bottom = bottom + "px";
        s.style.animationDelay = delay + "s";
        s.style.animationDuration = dur + "s";
        s.style.width = size + "px";
        s.style.height = size + "px";
        document.body.appendChild(s);
      }
    }

    async function runSequence(db){
      const lines = [
        "参拝のお客様ですね？",
        "私 AI が祈らせて頂きます",
        "祈願中...",
        "祈願が完了しました。",
        "またのお越しをお待ちしています。",
        "本日祈願済み"
      ];

      for(let i=0;i<lines.length;i++){
        setText(lines[i]);
        if(i === 2){
          await sleep(2800);
          await sleep(1900);
        } else if(i === 3){
          await sleep(2400);
        } else {
          await sleep(2250);
        }
      }

      await setValue(db, KEY, todayKey());
    }

    (async () => {
      spawnSparks();
      let db = null;
      try{
        db = await openDB();
        const last = await getValue(db, KEY);
        if(last === todayKey()){
          setText("本日祈願済み");
          return;
        }
        await runSequence(db);
      }catch(e){
        // IndexedDBが使えない環境は保存なしで毎回実行
        const fallback = [
          "参拝のお客様ですね？",
          "私 AI が祈らせて頂きます",
          "祈願中...",
          "祈願が完了しました。",
          "またのお越しをお待ちしています。",
          "本日祈願済み"
        ];
        for(const t of fallback){
          setText(t);
          await sleep(1200);
        }
      }finally{
        try{ db && db.close(); }catch(_){}
      }
    })();
  </script>
</body>
</html>
