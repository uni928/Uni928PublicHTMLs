<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Fill From Query - URL Builder</title>
  <style>
    :root{
      --bg: #fff4dc;          /* ã‚¯ãƒªãƒ¼ãƒ è‰² */
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.62);
      --ink: #1f2937;
      --muted: #6b7280;
      --line: rgba(31,41,55,.14);
      --shadow: 0 18px 60px rgba(17,24,39,.10);
      --shadow2: 0 10px 30px rgba(17,24,39,.08);
      --radius: 18px;
      --radius2: 14px;
      --accent: #2b6cb0;
      --accent2: #2f855a;
      --danger: #b91c1c;
      --warn: #b45309;
      --focus: 0 0 0 4px rgba(43,108,176,.18);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 5%, rgba(47,133,90,.10), transparent 55%),
        radial-gradient(1100px 680px at 85% 10%, rgba(43,108,176,.12), transparent 55%),
        radial-gradient(900px 600px at 65% 85%, rgba(180,83,9,.10), transparent 50%),
        var(--bg);
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 18px 64px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo{
      width:44px;height:44px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(43,108,176,.18), rgba(47,133,90,.18));
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      border:1px solid rgba(31,41,55,.10);
      backdrop-filter: blur(10px);
    }
    .logo svg{ width:26px; height:26px; opacity:.9; }

    h1{
      font-size: 20px;
      margin:0;
      letter-spacing:.2px;
    }

    .sub{
      margin:4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
    }

    .top-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      appearance:none;
      border:1px solid rgba(31,41,55,.14);
      background: rgba(255,255,255,.78);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: 0 8px 24px rgba(17,24,39,.06);
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 14px 38px rgba(17,24,39,.10); }
    button:active{ transform: translateY(0px) scale(.99); }
    button:focus{ outline:none; box-shadow: var(--focus); }
    .btn-primary{
      background: linear-gradient(180deg, rgba(43,108,176,.95), rgba(43,108,176,.88));
      border-color: rgba(43,108,176,.35);
      color: #fff;
    }
    .btn-success{
      background: linear-gradient(180deg, rgba(47,133,90,.92), rgba(47,133,90,.84));
      border-color: rgba(47,133,90,.35);
      color:#fff;
    }
    .btn-ghost{
      background: rgba(255,255,255,.55);
    }
    .btn-danger{
      background: rgba(185,28,28,.10);
      border-color: rgba(185,28,28,.22);
      color: var(--danger);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(31,41,55,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .card-head{
      padding: 14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(31,41,55,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.45));
    }

    .title-row{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 0;
    }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 700;
      color: rgba(31,41,55,.75);
      background: rgba(31,41,55,.06);
      border: 1px solid rgba(31,41,55,.10);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .card-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .card-body{
      padding: 14px;
      display:grid;
      gap: 12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .row{ grid-template-columns: 1fr; }
      header{ align-items:flex-start; flex-direction:column; }
      .top-actions{ justify-content:flex-start; }
    }

    label{
      display:block;
      font-size: 12px;
      color: rgba(31,41,55,.70);
      font-weight: 800;
      margin-bottom: 6px;
      letter-spacing:.2px;
    }

    input[type="text"], textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid rgba(31,41,55,.14);
      background: rgba(255,255,255,.86);
      color: var(--ink);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      font-size: 14px;
    }
    input[type="text"]:focus, textarea:focus{
      box-shadow: var(--focus);
      border-color: rgba(43,108,176,.40);
      background: rgba(255,255,255,.95);
    }

    .params{
      background: rgba(255,255,255,.52);
      border: 1px solid rgba(31,41,55,.10);
      border-radius: var(--radius);
      padding: 12px;
      display:grid;
      gap: 10px;
    }

    .params-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .help{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .param-row{
      display:grid;
      grid-template-columns: 1fr 1.2fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(31,41,55,.10);
      border-radius: 14px;
    }
    @media (max-width: 640px){
      .param-row{ grid-template-columns: 1fr; }
    }

    .mini{
      padding: 9px 10px;
      border-radius: 12px;
      font-weight: 800;
    }

    .preview{
      display:grid;
      gap: 8px;
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(31,41,55,.04);
      border: 1px dashed rgba(31,41,55,.18);
    }

    .preview .mono{
      font-family: var(--mono);
      font-size: 12.5px;
      color: rgba(31,41,55,.85);
      word-break: break-all;
      line-height: 1.5;
    }

    .hintline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(17,24,39,.90);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      box-shadow: 0 18px 60px rgba(17,24,39,.20);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
      max-width: min(720px, calc(100vw - 24px));
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    .muted{
      color: var(--muted);
      font-weight: 700;
      font-size: 12px;
    }

    .footer-note{
      margin-top: 14px;
      color: rgba(31,41,55,.62);
      font-size: 12px;
      line-height: 1.5;
    }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
      clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M4 6.5C4 5.12 5.12 4 6.5 4h11C18.88 4 20 5.12 20 6.5v11C20 18.88 18.88 20 17.5 20h-11C5.12 20 4 18.88 4 17.5v-11Z" stroke="rgba(31,41,55,.85)" stroke-width="1.6"/>
            <path d="M7 9h10M7 12h7M7 15h10" stroke="rgba(31,41,55,.75)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Auto Fill From Query - è£œåŠ©URLãƒ“ãƒ«ãƒ€ãƒ¼</h1>
          <p class="sub">URLã¨ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¦ã€ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼ˆåŒä¸€ã‚¿ãƒ–/æ–°ã—ã„ã‚¿ãƒ–ï¼‰ã€‚<span class="muted">IndexedDBã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜</span></p>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn-primary" id="addUrlBtn" type="button">
          <span aria-hidden="true">ï¼‹</span> URLã‚’è¿½åŠ 
        </button>
        <button class="btn-ghost" id="exportBtn" type="button">
          <span aria-hidden="true">â¤“</span> JSONæ›¸ãå‡ºã—
        </button>
        <button class="btn-ghost" id="importBtn" type="button">
          <span aria-hidden="true">â¤’</span> JSONèª­ã¿è¾¼ã¿
        </button>
        <button class="btn-danger" id="resetBtn" type="button" title="å…¨æ¶ˆå»ã—ã¦åˆæœŸåŒ–">
          <span aria-hidden="true">ğŸ—‘</span> å…¨æ¶ˆå»
        </button>
        <input class="sr-only" id="importFile" type="file" accept="application/json" />
      </div>
    </header>

    <div class="grid" id="list"></div>

    <div class="footer-note">
      ãƒ»ã‚¯ã‚¨ãƒªã‚­ãƒ¼ã¯ã€æ‹¡å¼µãŒå‚ç…§ã™ã‚‹ <span class="muted">id / class / name</span> ã¨ä¸€è‡´ã•ã›ã‚‹æƒ³å®šã§ã™ï¼ˆä¾‹ï¼š<span class="muted">input-text</span>ï¼‰ã€‚<br/>
      ãƒ»ä¿å­˜ã¯IndexedDBã§è¡Œã„ã¾ã™ã€‚ãƒšãƒ¼ã‚¸æ›´æ–°/å†èµ·å‹•å¾Œã‚‚å‰å›ã®çŠ¶æ…‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <template id="tpl-card">
    <section class="card" data-card>
      <div class="card-head">
        <div class="title-row">
          <div class="badge" data-badge>URL #1</div>
          <div class="muted" data-status></div>
        </div>
        <div class="card-actions">
          <button class="btn-success mini" data-open type="button">é–‹ã</button>
          <button class="btn-primary mini" data-open-new type="button">æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã</button>
          <button class="btn-ghost mini" data-add-param type="button">ï¼‹ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</button>
          <button class="btn-danger mini" data-remove type="button">å‰Šé™¤</button>
        </div>
      </div>

      <div class="card-body">
        <div class="row">
          <div>
            <label>ãƒ™ãƒ¼ã‚¹URL</label>
            <input type="text" data-base placeholder="https://example.com/path" />
          </div>
          <div class="preview">
            <div class="hintline">
              <span class="muted">ç”ŸæˆURL</span>
              <button class="btn-ghost mini" data-copy type="button">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div class="mono" data-preview></div>
          </div>
        </div>

        <div class="params">
          <div class="params-head">
            <div>
              <div class="muted">ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>
              <div class="help">ã‚­ãƒ¼ã¯ input/textarea ã® <b>id / class / name</b> ã¨ä¸€è‡´ã•ã›ã‚‹ã¨æ‹¡å¼µãŒè‡ªå‹•å…¥åŠ›ã§ãã¾ã™ã€‚</div>
            </div>
          </div>
          <div data-params></div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-param">
    <div class="param-row" data-param>
      <div>
        <label style="margin:0 0 6px;">ã‚­ãƒ¼</label>
        <input type="text" data-key placeholder="input-text" />
      </div>
      <div>
        <label style="margin:0 0 6px;">å€¤</label>
        <input type="text" data-val placeholder="aaa" />
      </div>
      <div>
        <label style="margin:0 0 6px;">&nbsp;</label>
        <button class="btn-danger mini" data-del-param type="button">å‰Šé™¤</button>
      </div>
    </div>
  </template>

  <script>
    "use strict";

    // ===== IndexedDB =====
    const DB_NAME = "auto_fill_helper_site_db";
    const DB_VER = 1;
    const STORE = "kv";
    const KEY = "app_state_v1";

    function openDB(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = () => {
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            db.createObjectStore(STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbGet(db, key){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const st = tx.objectStore(STORE);
        const req = st.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbSet(db, key, val){
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const st = tx.objectStore(STORE);
        const req = st.put(val, key);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
      });
    }
    // =====================

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const listEl = $("#list");
    const tplCard = $("#tpl-card");
    const tplParam = $("#tpl-param");
    const toastEl = $("#toast");

    let db = null;
    let state = {
      urls: [
        {
          base: "https://example.com/",
          params: [{ key: "input-text", val: "aaa" }]
        }
      ]
    };

    // ä¿å­˜ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  / é€£æ‰“è€æ€§ï¼‰
    let saveTimer = null;
    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        try{
          const snapshot = readStateFromDOM();
          state = snapshot;
          await idbSet(db, KEY, snapshot);
        }catch(e){
          console.warn("save failed:", e);
        }
      }, 200);
    }

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1400);
    }

    function safeURL(base){
      try{
        return new URL(base);
      }catch(_){
        return null;
      }
    }

    function buildFullUrl(base, params){
      const u = safeURL(base);
      if(!u) return null;

      // æ—¢å­˜ã‚¯ã‚¨ãƒªã‚‚ä¿æŒã—ã¤ã¤ã€è¿½åŠ åˆ†ã‚’ä¸Šæ›¸ã/è¿½åŠ 
      const sp = new URLSearchParams(u.search);
      for(const p of params){
        const k = (p.key ?? "").trim();
        if(!k) continue;
        sp.set(k, p.val ?? "");
      }
      u.search = sp.toString();
      return u.toString();
    }

    function renumberBadges(){
      $$(".card[data-card]", listEl).forEach((card, idx) => {
        const badge = $("[data-badge]", card);
        badge.textContent = `URL #${idx + 1}`;
      });
    }

    function createParamRow(p = {key:"", val:""}){
      const node = tplParam.content.firstElementChild.cloneNode(true);
      $("[data-key]", node).value = p.key ?? "";
      $("[data-val]", node).value = p.val ?? "";
      return node;
    }

    function updatePreview(card){
      const base = $("[data-base]", card).value.trim();
      const params = $$("[data-param]", card).map(row => ({
        key: $("[data-key]", row).value,
        val: $("[data-val]", row).value
      }));

      const status = $("[data-status]", card);
      const preview = $("[data-preview]", card);

      const full = buildFullUrl(base, params);
      if(!full){
        status.textContent = base ? "URLãŒä¸æ­£ã§ã™" : "";
        status.style.color = base ? "var(--warn)" : "rgba(31,41,55,.45)";
        preview.textContent = base ? "ï¼ˆã“ã“ã«ç”ŸæˆURLãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰" : "ï¼ˆãƒ™ãƒ¼ã‚¹URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰";
        preview.style.opacity = .85;
        return;
      }

      status.textContent = "OK";
      status.style.color = "var(--accent2)";
      preview.textContent = full;
      preview.style.opacity = 1;
    }

    function createCard(item){
      const card = tplCard.content.firstElementChild.cloneNode(true);

      // base
      $("[data-base]", card).value = item.base ?? "";

      // params
      const paramsWrap = $("[data-params]", card);
      (item.params ?? []).forEach(p => paramsWrap.appendChild(createParamRow(p)));
      if((item.params ?? []).length === 0){
        paramsWrap.appendChild(createParamRow());
      }

      // åˆæœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      updatePreview(card);

      return card;
    }

    function render(){
      listEl.innerHTML = "";
      for(const item of state.urls){
        listEl.appendChild(createCard(item));
      }
      renumberBadges();
    }

    function readStateFromDOM(){
      const urls = $$(".card[data-card]", listEl).map(card => {
        const base = $("[data-base]", card).value;
        const params = $$("[data-param]", card).map(row => ({
          key: $("[data-key]", row).value,
          val: $("[data-val]", row).value
        }));
        return { base, params };
      });
      return { urls };
    }

    function addUrl(){
      state.urls.push({ base: "", params: [{key:"", val:""}] });
      render();
      scheduleSave();
      toast("URLã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    }

    function deleteUrl(card){
      const idx = $$(".card[data-card]", listEl).indexOf(card);
      if(idx >= 0){
        state.urls.splice(idx, 1);
        if(state.urls.length === 0){
          state.urls.push({ base:"", params:[{key:"", val:""}] });
        }
        render();
        scheduleSave();
        toast("URLã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
      }
    }

    function addParam(card){
      const wrap = $("[data-params]", card);
      wrap.appendChild(createParamRow());
      updatePreview(card);
      scheduleSave();
    }

    function deleteParam(row){
      const card = row.closest(".card[data-card]");
      const wrap = row.parentElement;
      row.remove();
      if(wrap.querySelectorAll("[data-param]").length === 0){
        wrap.appendChild(createParamRow());
      }
      updatePreview(card);
      scheduleSave();
    }

    function openUrl(card, newTab){
      updatePreview(card);
      const full = $("[data-preview]", card).textContent.trim();
      const ok = full && !full.startsWith("ï¼ˆ");
      if(!ok){
        toast("URLãŒä¸æ­£ã§ã™");
        return;
      }
      if(newTab){
        window.open(full, "_blank", "noopener,noreferrer");
      }else{
        location.href = full;
      }
    }

    async function copyUrl(card){
      updatePreview(card);
      const full = $("[data-preview]", card).textContent.trim();
      const ok = full && !full.startsWith("ï¼ˆ");
      if(!ok){
        toast("ã‚³ãƒ”ãƒ¼ã§ãã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }
      try{
        await navigator.clipboard.writeText(full);
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }catch(_){
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const ta = document.createElement("textarea");
        ta.value = full;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }
    }

    function exportJSON(){
      const snapshot = readStateFromDOM();
      const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "auto-fill-url-builder.json";
      a.click();
      URL.revokeObjectURL(url);
      toast("æ›¸ãå‡ºã—ã¾ã—ãŸ");
    }

    function importJSONFile(file){
      const reader = new FileReader();
      reader.onload = async () => {
        try{
          const obj = JSON.parse(String(reader.result || "{}"));
          if(!obj || !Array.isArray(obj.urls)) throw new Error("invalid format");
          // æœ€ä½é™ã®æ­£è¦åŒ–
          state = {
            urls: obj.urls.map(u => ({
              base: String(u.base ?? ""),
              params: Array.isArray(u.params) ? u.params.map(p => ({
                key: String(p.key ?? ""),
                val: String(p.val ?? "")
              })) : [{key:"", val:""}]
            }))
          };
          if(state.urls.length === 0){
            state.urls.push({ base:"", params:[{key:"", val:""}] });
          }
          render();
          await idbSet(db, KEY, state);
          toast("èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
        }catch(e){
          console.warn(e);
          toast("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      };
      reader.readAsText(file);
    }

    async function resetAll(){
      const ok = confirm("ã™ã¹ã¦å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
      if(!ok) return;
      state = { urls: [{ base:"", params:[{key:"", val:""}] }] };
      render();
      await idbSet(db, KEY, state);
      toast("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    }

    // ===== ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå§”è­²ï¼‰=====
    listEl.addEventListener("click", (e) => {
      const t = e.target;
      const card = t.closest(".card[data-card]");
      if(!card) return;

      if(t.matches("[data-remove]")) return deleteUrl(card);
      if(t.matches("[data-add-param]")) return addParam(card);
      if(t.matches("[data-open]")) return openUrl(card, false);
      if(t.matches("[data-open-new]")) return openUrl(card, true);
      if(t.matches("[data-copy]")) return copyUrl(card);

      const row = t.closest("[data-param]");
      if(row && t.matches("[data-del-param]")) return deleteParam(row);
    });

    listEl.addEventListener("input", (e) => {
      const card = e.target.closest(".card[data-card]");
      if(card){
        updatePreview(card);
        scheduleSave();
      }
    });

    $("#addUrlBtn").addEventListener("click", addUrl);
    $("#exportBtn").addEventListener("click", exportJSON);
    $("#importBtn").addEventListener("click", () => $("#importFile").click());
    $("#importFile").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if(file) importJSONFile(file);
      e.target.value = "";
    });
    $("#resetBtn").addEventListener("click", resetAll);

    // ===== èµ·å‹• =====
    (async function boot(){
      try{
        db = await openDB();
        const saved = await idbGet(db, KEY);
        if(saved && typeof saved === "object" && Array.isArray(saved.urls)){
          state = saved;
          if(state.urls.length === 0){
            state.urls = [{ base:"", params:[{key:"", val:""}] }];
          }
        }
      }catch(e){
        console.warn("IndexedDB init failed:", e);
        toast("ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
      }
      render();

      // åˆå›ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜ãŒå‹•ãã‚ˆã†ã«åŒæœŸ
      scheduleSave();
    })();
  </script>
</body>
</html>
