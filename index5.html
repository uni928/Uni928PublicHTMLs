<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ–‡ç« ä½œæˆã‚¹ã‚¿ã‚¸ã‚ª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --bg-gradient: radial-gradient(circle at top, #1d4ed8 0, #020617 55%);
    --card-bg: rgba(15,23,42,0.9);
    --accent: #38bdf8;
    --accent-soft: rgba(56,189,248,0.2);
    --accent-strong: #0ea5e9;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --border-soft: rgba(148,163,184,0.25);
    --danger: #fb7185;
    --danger-soft: rgba(248,113,113,0.12);
    --shadow-soft: 0 24px 60px rgba(15,23,42,0.9);
    --radius-xl: 1.4rem;
    --radius-lg: 1rem;
    --radius-pill: 999px;
    --transition-fast: 0.18s ease-out;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    min-height: 100vh;
    background: var(--bg-gradient);
    color: var(--text-main);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    display: flex;
    align-items: stretch;
    justify-content: center;
    padding: 24px;
  }

  .app-shell {
    max-width: 1120px;
    width: 100%;
    display: grid;
    grid-template-columns: minmax(0, 3fr) minmax(260px, 1.15fr);
    gap: 20px;
  }

  @media (max-width: 900px) {
    body {
      padding: 16px;
    }
    .app-shell {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .editor-card,
  .side-card {
    background: var(--card-bg);
    border-radius: var(--radius-xl);
    border: 1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);
    position: relative;
    overflow: hidden;
  }

  /* subtle glow border */
  .editor-card::before,
  .side-card::before {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: inherit;
    pointer-events: none;
    border: 1px solid transparent;
    background:
      linear-gradient(120deg, rgba(56,189,248,0.25), transparent 40%, rgba(139,92,246,0.15)) border-box;
    mask:
      linear-gradient(#000 0 0) padding-box,
      linear-gradient(#000 0 0);
    mask-composite: exclude;
    opacity: 0.6;
  }

  .editor-inner,
  .side-inner {
    position: relative;
    padding: 20px 20px 18px;
  }

  @media (max-width: 600px) {
    .editor-inner,
    .side-inner {
      padding: 14px;
    }
  }

  .app-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
  }

  .app-logo {
    width: 36px;
    height: 36px;
    border-radius: 16px;
    background: radial-gradient(circle at 30% 0%, #ffffff, #38bdf8 40%, #1d4ed8);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0f172a;
    font-weight: 800;
    font-size: 20px;
    letter-spacing: 0.05em;
    box-shadow: 0 12px 25px rgba(15,23,42,0.8);
  }

  .app-title-wrap {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    min-width: 0;
  }

  .app-title {
    font-size: 1.15rem;
    font-weight: 650;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #e5e7eb;
  }

  .app-subtitle {
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .autosave-pill {
    font-size: 0.72rem;
    padding: 4px 9px;
    border-radius: var(--radius-pill);
    border: 1px solid rgba(148,163,184,0.4);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(15,23,42,0.9);
    white-space: nowrap;
  }

  .autosave-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 0 6px rgba(34,197,94,0.2);
  }

  .autosave-pill[data-status="idle"] .autosave-dot {
    background: #eab308;
    box-shadow: 0 0 0 6px rgba(234,179,8,0.18);
  }

  .autosave-pill[data-status="error"] .autosave-dot {
    background: var(--danger);
    box-shadow: 0 0 0 6px rgba(248,113,113,0.18);
  }

  /* filename row */

  .filename-row {
    display: grid;
    grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.8fr);
    gap: 10px;
    align-items: end;
    margin-bottom: 10px;
  }

  @media (max-width: 768px) {
    .filename-row {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .field-label {
    font-size: 0.74rem;
    text-transform: uppercase;
    letter-spacing: 0.17em;
    color: var(--text-muted);
    margin-bottom: 4px;
  }

  .field-label strong {
    color: var(--accent);
    font-weight: 700;
  }

  .input-shell {
    position: relative;
  }

  .input-base,
  .input-preview {
    width: 100%;
    border-radius: var(--radius-lg);
    border: 1px solid rgba(148,163,184,0.6);
    background: rgba(15,23,42,0.85);
    color: var(--text-main);
    padding: 9px 12px;
    font-size: 0.88rem;
    outline: none;
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform 0.12s ease-out;
  }

  .input-base::placeholder {
    color: rgba(148,163,184,0.7);
  }

  .input-base:focus {
    border-color: var(--accent-strong);
    box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    background: rgba(15,23,42,0.98);
    transform: translateY(-1px);
  }

  .input-preview {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.8rem;
    opacity: 0.95;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .input-preview span {
    color: var(--accent);
  }

  /* editor area */

  .editor-area {
    margin-top: 6px;
    border-radius: 24px;
    border: 1px solid rgba(30,64,175,0.8);
    background: radial-gradient(circle at top left, rgba(56,189,248,0.18), rgba(15,23,42,0.9));
    padding: 10px;
    position: relative;
    overflow: hidden;
  }

  .editor-area::before {
    content: "";
    position: absolute;
    width: 220px;
    height: 220px;
    border-radius: 999px;
    background: radial-gradient(circle, rgba(56,189,248,0.12), transparent 70%);
    top: -120px;
    right: -60px;
    pointer-events: none;
  }

  .editor-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
  }

  .toolbar-left,
  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .toolbar-group {
    display: inline-flex;
    align-items: center;
    border-radius: var(--radius-pill);
    background: rgba(15,23,42,0.88);
    border: 1px solid rgba(148,163,184,0.4);
    overflow: hidden;
  }

  .btn {
    border: none;
    background: transparent;
    color: var(--text-main);
    font-size: 0.78rem;
    padding: 6px 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    transition: background var(--transition-fast), color var(--transition-fast), transform 0.08s ease-out, box-shadow 0.08s ease-out;
  }

  .btn span.key {
    font-size: 0.7rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    padding: 2px 6px;
    border-radius: 8px;
    background: rgba(15,23,42,0.9);
    border: 1px solid rgba(148,163,184,0.6);
  }

  .btn-icon {
    font-size: 0.95rem;
    opacity: 0.9;
  }

  .btn:hover {
    background: rgba(15,23,42,0.96);
    transform: translateY(-0.5px);
  }

  .btn:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 0 0 0 rgba(0,0,0,0);
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent-strong), #4f46e5);
    color: #0b1120;
    font-weight: 600;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #38bdf8, #6366f1);
    box-shadow: 0 10px 25px rgba(37,99,235,0.45);
  }

  .btn-primary .key {
    background: rgba(15,23,42,0.9);
    color: var(--accent);
    border-color: rgba(15,23,42,0.9);
  }

  .btn-outline {
    border-radius: var(--radius-pill);
  }

  .btn-small {
    font-size: 0.72rem;
    padding: 4px 8px;
  }

  .btn-disabled {
    opacity: 0.4;
    cursor: default;
    pointer-events: none;
  }

  .hint-text {
    font-size: 0.7rem;
    color: var(--text-muted);
    opacity: 0.9;
  }

  .hint-text strong {
    color: #e5e7eb;
  }

  textarea#editor {
    width: 100%;
    min-height: 340px;
    max-height: calc(100vh - 260px);
    resize: vertical;
    border-radius: 18px;
    border: 1px solid rgba(148,163,184,0.4);
    padding: 14px 14px 50px;
    font-family: "SF Pro Text", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    font-size: 0.93rem;
    line-height: 1.7;
    background: rgba(15,23,42,0.96);
    color: var(--text-main);
    outline: none;
    box-shadow: inset 0 0 0 1px rgba(15,23,42,0.8);
    backdrop-filter: blur(14px);
  }

  textarea#editor::placeholder {
    color: rgba(148,163,184,0.85);
  }

  textarea#editor:focus {
    border-color: var(--accent-strong);
    box-shadow:
      inset 0 0 0 1px rgba(15,23,42,0.8),
      0 0 0 1px rgba(56,189,248,0.35);
  }

  /* stats bar */

  .stats-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    font-size: 0.74rem;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .stats-left,
  .stats-right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .stat-pill {
    padding: 4px 9px;
    border-radius: var(--radius-pill);
    background: rgba(15,23,42,0.96);
    border: 1px solid rgba(148,163,184,0.5);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .stat-label {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.66rem;
  }

  .stat-value {
    font-feature-settings: "tnum" 1,"lnum" 1;
    font-variant-numeric: tabular-nums lining-nums;
    color: #e5e7eb;
  }

  .stat-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(148,163,184,0.9);
  }

  /* side card */

  .side-inner {
    padding-top: 18px;
    padding-bottom: 16px;
  }

  .side-section + .side-section {
    margin-top: 14px;
    padding-top: 12px;
    border-top: 1px dashed rgba(148,163,184,0.35);
  }

  .side-title {
    font-size: 0.86rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  .kbd-inline {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.74rem;
    padding: 2px 6px;
    border-radius: 6px;
    border: 1px solid rgba(148,163,184,0.6);
    background: rgba(15,23,42,0.9);
  }

  .shortcut-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 4px 8px;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .shortcut-grid div:nth-child(odd) {
    text-align: right;
  }

  .shortcut-grid div:nth-child(even) {
    opacity: 0.9;
  }

  .timeline {
    border-radius: 14px;
    background: rgba(15,23,42,0.85);
    border: 1px solid rgba(148,163,184,0.4);
    padding: 9px 10px;
    font-size: 0.76rem;
    color: var(--text-muted);
  }

  .timeline-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 4px 0;
  }

  .timeline-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--accent);
    box-shadow: 0 0 0 4px rgba(56,189,248,0.25);
  }

  .timeline-label {
    font-size: 0.74rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .timeline-time {
    font-feature-settings: "tnum" 1,"lnum" 1;
    font-variant-numeric: tabular-nums lining-nums;
  }

  .history-buttons {
    display: flex;
    gap: 6px;
    margin-top: 6px;
  }

  .history-buttons .btn {
    flex: 1;
    justify-content: center;
  }

  .backup-note {
    font-size: 0.74rem;
    color: var(--text-muted);
    background: rgba(56,189,248,0.08);
    border-radius: 10px;
    padding: 8px 9px;
    border: 1px dashed rgba(56,189,248,0.6);
    margin-top: 6px;
  }

  .backup-note strong {
    color: var(--accent);
  }

  .danger-note {
    background: var(--danger-soft);
    border-color: rgba(248,113,113,0.7);
    color: #fecaca;
  }

  .file-input-hidden {
    display: none;
  }

  .linkish {
    color: var(--accent);
    text-decoration: underline;
    text-decoration-style: dotted;
    cursor: pointer;
  }
</style>
</head>
<body>
<div class="app-shell">
  <!-- main editor -->
  <div class="editor-card">
    <div class="editor-inner">
      <div class="app-header">
        <div class="app-logo">æ–‡</div>
        <div class="app-title-wrap">
          <div class="app-title">Writing Studio</div>
          <div class="app-subtitle">
            åŠ¹ç‡ã‚ˆããƒ»å®‰å…¨ã«ãƒ»ãã‚Œã„ã«æ–‡ç« ã‚’è‚²ã¦ã‚‹ãŸã‚ã®ã‚¨ãƒ‡ã‚£ã‚¿
          </div>
        </div>
        <div id="autosavePill" class="autosave-pill" data-status="idle">
          <div class="autosave-dot"></div>
          <span id="autosaveText">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ OK</span>
        </div>
      </div>

      <!-- filename -->
      <div class="filename-row">
        <div>
          <div class="field-label"><strong>ãƒ•ã‚¡ã‚¤ãƒ«å</strong> ãƒ™ãƒ¼ã‚¹</div>
          <div class="input-shell">
            <input id="filenameBase" class="input-base" type="text" placeholder="æ–‡ç« ä½œæˆ"
                   autocomplete="off" spellcheck="false">
          </div>
        </div>
        <div>
          <div class="field-label">ä¿å­˜æ™‚ã® <strong>å®Ÿãƒ•ã‚¡ã‚¤ãƒ«å</strong></div>
          <div class="input-shell">
            <div id="filenamePreview" class="input-preview" title="ä¿å­˜æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«å">
              æ–‡ç« ä½œæˆ_<span>YYYYMMDDHHMMSS</span>.json
            </div>
          </div>
        </div>
      </div>

      <!-- editor area -->
      <div class="editor-area">
        <!-- toolbar -->
        <div class="editor-toolbar">
          <div class="toolbar-left">
            <div class="toolbar-group">
              <button id="saveButton" class="btn btn-primary" type="button">
                <span class="btn-icon">ğŸ’¾</span>
                <span>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</span>
                <span class="key">Ctrl + S</span>
              </button>
            </div>
<div class="side-section">
  <div style="margin-top:8px;">
    <button id="clearLocalButton" class="btn btn-small btn-outline" type="button">
      ğŸ—‘ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å…¨ã¦æ¶ˆå»
    </button>
  </div>
</div>
            <div class="toolbar-group">
              <button id="undoButton" class="btn btn-outline" type="button">
                <span class="btn-icon">â¤º</span>
                <span>1 æ‰‹ æˆ»ã™</span>
                <span class="key">Ctrl + Z</span>
              </button>
              <button id="redoButton" class="btn btn-outline" type="button">
                <span class="btn-icon">â¤¼</span>
                <span>1 æ‰‹ é€²ã‚ã‚‹</span>
                <span class="key">Ctrl + Y</span>
              </button>
            </div>
          </div>
          <div class="toolbar-right">
            <span class="hint-text">
              è‡ªå‹•ã§ IndexedDB ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ç¶šãã‹ã‚‰å†é–‹</strong>ã§ãã¾ã™ã€‚
            </span>
          </div>
        </div>

        <!-- textarea -->
        <textarea id="editor" placeholder="ã“ã“ã«æ–‡ç« ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚&#10;&#10;ä¾‹ï¼‰ä»Šæ—¥ä½œã‚ŠãŸã„è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ»è¦‹å‡ºã—ãƒ»ç®‡æ¡æ›¸ãã‚’å…ˆã«ä¸¦ã¹ã¦ã‹ã‚‰ã€æœ¬æ–‡ã‚’æ›¸ãå§‹ã‚ã‚‹ã¨åŠ¹ç‡ãŒä¸ŠãŒã‚Šã¾ã™ã€‚"></textarea>

        <!-- stats -->
        <div class="stats-bar">
          <div class="stats-left">
            <div class="stat-pill">
              <div class="stat-dot"></div>
              <span class="stat-label">æ–‡å­—æ•°</span>
              <span id="charCount" class="stat-value">0</span>
            </div>
            <div class="stat-pill">
              <div class="stat-dot"></div>
              <span class="stat-label">è¡Œæ•°</span>
              <span id="lineCount" class="stat-value">1</span>
            </div>
          </div>
          <div class="stats-right">
            <div class="stat-pill">
              <span class="stat-label">æœ€çµ‚è‡ªå‹•ä¿å­˜</span>
              <span id="lastAutosaveTime" class="stat-value">â€”</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- side panel -->
  <div class="side-card">
    <div class="side-inner">
      <!-- shortcuts -->
      <div class="side-section">
        <div class="side-title">ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</div>
        <div class="shortcut-grid">
          <div><span class="kbd-inline">Ctrl + S</span></div>
          <div>å±¥æ­´è¾¼ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼‰</div>
          <div><span class="kbd-inline">Ctrl + Z</span></div>
          <div>1 æ‰‹å‰ã®çŠ¶æ…‹ã¸æˆ»ã‚‹ï¼ˆç‹¬è‡ª Undoï¼‰</div>
          <div><span class="kbd-inline">Ctrl + Y</span></div>
          <div>Undo ã‚’ 1 æ‰‹é€²ã‚ã‚‹ï¼ˆç‹¬è‡ª Redoï¼‰</div>
        </div>
      </div>

      <!-- version timeline -->
      <div class="side-section">
        <div class="side-title">ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´</div>
        <div class="timeline">
          <div class="timeline-row">
            <div style="display:flex;align-items:center;gap:6px;">
              <div class="timeline-dot"></div>
              <div>
                <div class="timeline-label">æœ€çµ‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                <div id="lastBackupTime" class="timeline-time">â€”</div>
              </div>
            </div>
          </div>
          <div class="history-buttons">
            <button id="stepBackButton" class="btn btn-small btn-outline" type="button">
              â® 1 ã¤æˆ»ã‚‹
            </button>
            <button id="stepForwardButton" class="btn btn-small btn-outline" type="button">
              â­ 1 ã¤é€²ã‚€
            </button>
          </div>
        </div>
        <div class="backup-note">
          ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã¯ <strong>Ctrl + Z / Ctrl + Y ã®å±¥æ­´</strong>ã‚‚ä¸€ç·’ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>
          å¾©å…ƒå¾Œã‚‚ã€ä¿å­˜æ™‚ç‚¹ã¾ã§ã® Undo / Redo ãŒãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚
        </div>
      </div>

      <!-- restore -->
      <div class="side-section">
        <div class="side-title">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</div>
        <div class="backup-note danger-note">
          <strong>åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»PC</strong>ã«ç§»ã—ãŸã„ã¨ãã‚„ã€ä¸‡ä¸€ã®ãŸã‚ã«<br>
          æ›¸ãå‡ºã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã‹ã‚‰èª­ã¿è¾¼ã‚ã¾ã™ã€‚
        </div>
        <div style="margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
          <button id="restoreButton" class="btn btn-small btn-outline" type="button">
            ğŸ“‚ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
          </button>
          <input id="restoreFileInput" class="file-input-hidden" type="file" accept=".json,application/json">
          <span id="restoreStatus" class="hint-text">
            èª­ã¿è¾¼ã¿å¾Œã¯è‡ªå‹•ä¿å­˜ã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // ---------- state ----------
const initialState = {
  title: 'æ–‡ç« ä½œæˆ',
  content: '',
  undoStack: [],
  redoStack: [],
  saveHistory: [],        // [{title, content, timestamp}]
  saveHistoryIndex: -1,
  lastAutosaveAt: null,
  lastBackupAt: null,
  lastEditTime: 0        // â˜… ç›´è¿‘ã®å…¥åŠ›æ™‚åˆ»ï¼ˆmsï¼‰
};


  let state = JSON.parse(JSON.stringify(initialState));
  let isApplyingHistory = false;   // ãƒ•ãƒ©ã‚°: Undo / Redo é©ç”¨ä¸­
  let db = null;
  const DB_NAME = 'writing_studio_db';
  const DB_VERSION = 1;
  const STORE_NAME = 'documents';
  const DOCUMENT_ID = 'current';

  // ---------- dom refs ----------
  const editorEl = document.getElementById('editor');
  const filenameBaseEl = document.getElementById('filenameBase');
  const filenamePreviewEl = document.getElementById('filenamePreview');
  const charCountEl = document.getElementById('charCount');
  const lineCountEl = document.getElementById('lineCount');
  const lastAutosaveTimeEl = document.getElementById('lastAutosaveTime');
  const lastBackupTimeEl = document.getElementById('lastBackupTime');
  const autosavePillEl = document.getElementById('autosavePill');
  const autosaveTextEl = document.getElementById('autosaveText');
  const saveButton = document.getElementById('saveButton');
  const undoButton = document.getElementById('undoButton');
  const redoButton = document.getElementById('redoButton');
  const stepBackButton = document.getElementById('stepBackButton');
  const stepForwardButton = document.getElementById('stepForwardButton');
  const restoreButton = document.getElementById('restoreButton');
  const restoreFileInput = document.getElementById('restoreFileInput');
  const restoreStatusEl = document.getElementById('restoreStatus');

  const clearLocalButton = document.getElementById('clearLocalButton');

  // ---------- utils ----------
  function pad2(n) { return n.toString().padStart(2, '0'); }
  function formatTimestamp14(date) {
    const y = date.getFullYear();
    const m = pad2(date.getMonth() + 1);
    const d = pad2(date.getDate());
    const hh = pad2(date.getHours());
    const mm = pad2(date.getMinutes());
    const ss = pad2(date.getSeconds());
    return `${y}${m}${d}${hh}${mm}${ss}`;
  }
  function formatReadable(date) {
    if (!date) return 'â€”';
    const d = new Date(date);
    if (isNaN(d.getTime())) return 'â€”';
    return `${d.getFullYear()}/${pad2(d.getMonth() + 1)}/${pad2(d.getDate())} `
      + `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  function sanitizeFilenameBase(str) {
    const base = (str || '').trim() || 'æ–‡ç« ä½œæˆ';
    // ç¦æ­¢æ–‡å­—ã‚’ _ ã«
    return base.replace(/[\\\/:*?"<>|]/g, '_');
  }

  function updateFilenamePreview() {
    const base = sanitizeFilenameBase(filenameBaseEl.value);
    const now = new Date();
    const ts = formatTimestamp14(now);
    filenamePreviewEl.innerHTML = `${base}_<span>${ts}</span>.json`;
  }

  function updateStats() {
    const text = state.content || '';
    charCountEl.textContent = text.length.toString();
    const lines = text.split(/\r\n|\r|\n/).length || 1;
    lineCountEl.textContent = lines.toString();
  }

  function updateAutosaveUI(status) {
    autosavePillEl.dataset.status = status || 'ok';
    if (status === 'error') {
      autosaveTextEl.textContent = 'ä¿å­˜ã‚¨ãƒ©ãƒ¼';
    } else if (status === 'idle') {
      autosaveTextEl.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ä¿å­˜ OK';
    } else {
      autosaveTextEl.textContent = 'è‡ªå‹•ä¿å­˜ä¸­â€¦';
    }
  }

  function refreshAllUI() {
    filenameBaseEl.value = state.title || 'æ–‡ç« ä½œæˆ';
    editorEl.value = state.content || '';
    updateFilenamePreview();
    updateStats();
    lastAutosaveTimeEl.textContent = state.lastAutosaveAt ? formatReadable(state.lastAutosaveAt) : 'â€”';
    lastBackupTimeEl.textContent = state.lastBackupAt ? formatReadable(state.lastBackupAt) : 'â€”';
    // history buttons enable/disable
    undoButton.classList.toggle('btn-disabled', state.undoStack.length === 0);
    redoButton.classList.toggle('btn-disabled', state.redoStack.length === 0);
    stepBackButton.classList.toggle('btn-disabled', state.saveHistoryIndex <= 0);
    stepForwardButton.classList.toggle(
      'btn-disabled',
      state.saveHistoryIndex < 0 || state.saveHistoryIndex >= state.saveHistory.length - 1
    );
  }

  // ---------- indexeddb ----------
  function openDatabase() {
    return new Promise(function(resolve, reject) {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onerror = function() {
        console.error('IndexedDB open error', req.error);
        updateAutosaveUI('error');
        reject(req.error);
      };
      req.onupgradeneeded = function(e) {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
      };
      req.onsuccess = function(e) {
        db = e.target.result;
        resolve(db);
      };
    });
  }

  function loadStateFromIndexedDB() {
    if (!db) return;
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(DOCUMENT_ID);
    req.onsuccess = function() {
      if (req.result) {
        state = Object.assign({}, initialState, req.result);
        // å®‰å…¨ã®ãŸã‚ ID ã¯å‰Šé™¤
        delete state.id;
      }
      refreshAllUI();
      updateAutosaveUI('idle');
    };
    req.onerror = function() {
      console.error('IndexedDB load error', req.error);
    };
  }

  let autosaveTimer = null;
  function scheduleAutosave() {
    updateAutosaveUI('saving');
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(saveStateToIndexedDB, 400);
  }

  function saveStateToIndexedDB() {
    if (!db) return;
    state.lastAutosaveAt = new Date().toISOString();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const dataToStore = Object.assign({ id: DOCUMENT_ID }, state);
    const req = store.put(dataToStore);
    req.onsuccess = function() {
      lastAutosaveTimeEl.textContent = formatReadable(state.lastAutosaveAt);
      updateAutosaveUI('idle');
    };
    req.onerror = function() {
      console.error('IndexedDB save error', req.error);
      updateAutosaveUI('error');
    };
  }

  // ---------- history: undo/redo ----------
// â˜… ä½•ãƒŸãƒªç§’ä»¥ä¸Šé–“ãŒç©ºã„ãŸã‚‰ã€Œåˆ¥ã®å¡Šã€ã¨ã¿ãªã™ã‹
const UNDO_GROUP_MS = 400; //0.4ç§’ã€‚ãŠå¥½ã¿ã§èª¿æ•´OK
let nextInputForceNewGroup = false; // â˜… Enter ç”¨ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
let isComposing = false;

// å¤‰æ›´å‰ãƒ»å¤‰æ›´å¾Œã€ãŠã‚ˆã³ã€Œå¼·åˆ¶ã€ã®æœ‰ç„¡ã‹ã‚‰ Undo ã‚’ç©ã‚€ã‹åˆ¤æ–­
function pushUndo(beforeContent, afterContent, forceNewGroup) {
  if (isApplyingHistory) return;
  // â˜… undoStack ã®æœ€å¾Œã®è¦ç´ ãŒã‚ã‚‹å ´åˆ â†’ afterContent ã‚’ãã‚Œã«ç½®ãæ›ãˆã‚‹
  if (state.undoStack.length > 0) {
   if( editorEl.value ==  state.undoStack[state.undoStack.length - 1]) return;
  }

  const now = Date.now();
  const lastTime = state.lastEditTime || 0;

  // â˜… forceNewGroup ãŒ true ã®ã¨ãã¯æ™‚é–“é–“éš”ã«é–¢ã‚ã‚‰ãšã€Œæ–°ã—ã„å¡Šã€ã¨ã—ã¦ç™»éŒ²
  if (nextInputForceNewGroup || (now - lastTime > UNDO_GROUP_MS)) {
    state.undoStack.push(afterContent);

    // ä¸Šé™
    if (state.undoStack.length > 500) {
      state.undoStack.shift();
    }

    // æ–°ã—ã„å…¥åŠ›ãŒå…¥ã£ãŸã®ã§ Redo ã¯æ¶ˆãˆã‚‹
    state.redoStack = [];
  }

  // æœ€å¾Œã®ç·¨é›†æ™‚åˆ»ã‚’æ›´æ–°
  state.lastEditTime = now;

  if (state.undoStack.length > 1) {
   if( state.undoStack[state.undoStack.length - 1] ==  state.undoStack[state.undoStack.length - 2]) state.undoStack.pop();;
  }
}



  function applyContent(newContent) {
    isApplyingHistory = true;
    state.content = newContent;
    editorEl.value = newContent;
    updateStats();
    scheduleAutosave();
    isApplyingHistory = false;
  }

  function handleUndo() {
    if (state.undoStack.length === 0) return;
    if(state.undoStack[state.undoStack.length - 1] == editorEl.value) {
    const previous = state.undoStack.pop();
    state.redoStack.push(state.content);
    }
    if (state.undoStack.length > 1 && state.undoStack[state.undoStack.length - 1] == state.undoStack[state.undoStack.length - 2]) {
    state.undoStack.pop();
    }
    const previous = state.undoStack.pop();
    state.redoStack.push(state.content);
    applyContent(previous);
    refreshAllUI();
  }

  function handleRedo() {
    if (state.redoStack.length === 0) return;
    const next = state.redoStack.pop();
    state.undoStack.push(state.content);
    applyContent(next);
    refreshAllUI();
  }

  // ---------- save history (1ã¤æˆ»ã‚‹ / 1ã¤é€²ã‚€) ----------
  function pushSaveHistorySnapshot(timestampISO) {
    const snapshot = {
      title: state.title,
      content: state.content,
      timestamp: timestampISO || new Date().toISOString()
    };
    // é€”ä¸­ã«ã„ã‚‹å ´åˆã¯ã€ãã“ã‹ã‚‰å…ˆã‚’ç ´æ£„
    if (state.saveHistoryIndex >= 0 && state.saveHistoryIndex < state.saveHistory.length - 1) {
      state.saveHistory = state.saveHistory.slice(0, state.saveHistoryIndex + 1);
    }
    state.saveHistory.push(snapshot);
    state.saveHistoryIndex = state.saveHistory.length - 1;

    // æœ€å¤§æ•°åˆ¶é™ï¼ˆä¾‹: 50ï¼‰
    if (state.saveHistory.length > 50) {
      const diff = state.saveHistory.length - 50;
      state.saveHistory.splice(0, diff);
      state.saveHistoryIndex = state.saveHistory.length - 1;
    }
  }

  function handleStepBack() {
    if (state.saveHistoryIndex <= 0) return;
    state.saveHistoryIndex -= 1;
    const snap = state.saveHistory[state.saveHistoryIndex];
    // ã“ã“ã§ã¯ Undo/Redo ã®å±¥æ­´ã¯ã‚¯ãƒªã‚¢ã—ã¦ã€çŠ¶æ…‹ã‚’ã€Œç¯€ç›®ã€ã¨ã—ã¦å†ã‚¹ã‚¿ãƒ¼ãƒˆ
    state.undoStack = [];
    state.redoStack = [];
    state.title = snap.title;
    state.content = snap.content;
    refreshAllUI();
    scheduleAutosave();
  }

function handleClearLocalData() {
  if (!confirm('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æ–‡ç« ã¨å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚\næœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
    return;
  }

  // IndexedDB ã® current ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
  if (db) {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.delete(DOCUMENT_ID);
    req.onerror = function() {
      console.error('IndexedDB delete error', req.error);
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    };
    req.onsuccess = function() {
      // ãƒ¡ãƒ¢ãƒªä¸Šã® state ã‚‚ãƒªã‚»ãƒƒãƒˆ
      state = JSON.parse(JSON.stringify(initialState));
      refreshAllUI();
      updateAutosaveUI('idle');
      lastAutosaveTimeEl.textContent = 'â€”';
      lastBackupTimeEl.textContent = 'â€”';
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚æœ€åˆã®çŠ¶æ…‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚');
    };
  } else {
    // å¿µã®ãŸã‚ IndexedDB ã”ã¨å‰Šé™¤ã«æŒ‘æˆ¦
    const delReq = indexedDB.deleteDatabase(DB_NAME);
    delReq.onsuccess = function() {
      state = JSON.parse(JSON.stringify(initialState));
      refreshAllUI();
      updateAutosaveUI('idle');
      lastAutosaveTimeEl.textContent = 'â€”';
      lastBackupTimeEl.textContent = 'â€”';
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚æœ€åˆã®çŠ¶æ…‹ã‹ã‚‰å†é–‹ã—ã¾ã™ã€‚');
    };
    delReq.onerror = function() {
      console.error('deleteDatabase error', delReq.error);
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    };
  }
}

clearLocalButton.addEventListener('click', function() {
  handleClearLocalData();
});

  function handleStepForward() {
    if (state.saveHistoryIndex < 0 || state.saveHistoryIndex >= state.saveHistory.length - 1) return;
    state.saveHistoryIndex += 1;
    const snap = state.saveHistory[state.saveHistoryIndex];
    state.undoStack = [];
    state.redoStack = [];
    state.title = snap.title;
    state.content = snap.content;
    refreshAllUI();
    scheduleAutosave();
  }

  // ---------- backup save (download) ----------
function handleBackupSave() {
  const now = new Date();
  const timestamp14 = formatTimestamp14(now);
  const base = sanitizeFilenameBase(filenameBaseEl.value);
  const filename = `${base}_${timestamp14}.json`;

  const backupData = {
    version: 1,
    title: state.title,
    content: state.content,
    undoStack: state.undoStack.slice(),
    redoStack: state.redoStack.slice(),
    saveHistory: state.saveHistory.slice(),
    saveHistoryIndex: state.saveHistoryIndex,
    createdAt: now.toISOString()
  };

  const json = JSON.stringify(backupData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });

  // â˜… ä¿å­˜å…ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã•ãšã€ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã«æµã™
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;           // â† ã“ã“ã§ãƒ•ã‚¡ã‚¤ãƒ«åã ã‘æŒ‡å®šï¼ˆä¿å­˜å…ˆã¯ãƒ–ãƒ©ã‚¦ã‚¶ä»»ã›ï¼‰
  a.style.display = 'none';

  document.body.appendChild(a);
  a.click();                       // â† è‡ªå‹•ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹
  document.body.removeChild(a);
  URL.revokeObjectURL(url);        // å¾Œå§‹æœ«

  // ä»¥é™ã¯å†…éƒ¨çŠ¶æ…‹ã®æ›´æ–°
  state.lastBackupAt = backupData.createdAt;
  lastBackupTimeEl.textContent = formatReadable(state.lastBackupAt);

  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚‚ saveHistory ã«ç™»éŒ²
  pushSaveHistorySnapshot(backupData.createdAt);

  refreshAllUI();
  scheduleAutosave();
}


  // ---------- backup restore (upload) ----------
  function handleBackupRestoreFile(file) {
    if (!file) return;
    restoreStatusEl.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';

    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const text = ev.target.result;
        const data = JSON.parse(text);
        if (typeof data !== 'object' || data === null || !('content' in data)) {
          throw new Error('ä¸æ­£ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å½¢å¼ã§ã™');
        }

        state.title = data.title || 'æ–‡ç« ä½œæˆ';
        state.content = data.content || '';
        state.undoStack = Array.isArray(data.undoStack) ? data.undoStack.slice() : [];
        state.redoStack = Array.isArray(data.redoStack) ? data.redoStack.slice() : [];
        state.saveHistory = Array.isArray(data.saveHistory) ? data.saveHistory.slice() : [];
        state.saveHistoryIndex = typeof data.saveHistoryIndex === 'number'
          ? data.saveHistoryIndex
          : (state.saveHistory.length - 1);
        state.lastBackupAt = data.createdAt || null;
        // å¾©å…ƒç›´å¾Œã® autosave æ™‚é–“ã‚‚ç¾åœ¨ã«ã—ã¦ãŠã
        state.lastAutosaveAt = new Date().toISOString();

        refreshAllUI();
        saveStateToIndexedDB();

        restoreStatusEl.textContent = 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚Undo / Redo ã‚‚å¾©å…ƒã•ã‚Œã¦ã„ã¾ã™ã€‚';
      } catch (err) {
        console.error('restore error', err);
        restoreStatusEl.textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      }
    };
    reader.onerror = function() {
      console.error('file read error', reader.error);
      restoreStatusEl.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
    };
    reader.readAsText(file, 'utf-8');
  }

  // ---------- event handlers ----------
editorEl.addEventListener('input', function() {
  const newContent = editorEl.value;
  const previousContent = state.content;

  // â˜… Enter ã‚­ãƒ¼ãªã©ã§ã€Œæ¬¡ã®å…¥åŠ›ã¯å¿…ãšæ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã€ã¨æŒ‡å®šã•ã‚ŒãŸå ´åˆã€
  //   ãã®ãƒ•ãƒ©ã‚°ã‚’ã“ã“ã§æ¸¡ã™
  pushUndo(previousContent, newContent, nextInputForceNewGroup);

  // ãƒ•ãƒ©ã‚°ã¯1å›ä½¿ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
  nextInputForceNewGroup = false;

  state.content = newContent;
  updateStats();
  scheduleAutosave();
  refreshAllUI();
});

document.addEventListener('keydown', function(e) {
    const key1 = e.key.toLowerCase();
    const ctrlOrMeta = e.ctrlKey || e.metaKey;

    if (ctrlOrMeta) {

    if (key1 === 's') {
      e.preventDefault();
      handleBackupSave();
    } else if (key1 === 'z') {
      e.preventDefault();
      handleUndo();
    } else if (key1 === 'y' || (key1 === 'z' && e.shiftKey)) {
      // Ctrl+Y ã¾ãŸã¯ Ctrl+Shift+Z ã§ Redo
      e.preventDefault();
      handleRedo();
    }
    }

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒ editorï¼ˆtextareaï¼‰ã®ã¨ãã ã‘åå¿œã•ã›ã‚‹
  if (e.target !== editorEl) return;

  const key = e.key;

  if (
    e.code === 'Enter' ||
    e.code === 'NumpadEnter' ||
    e.keyCode === 13 // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶/IME ç”¨
  ) {
    // æ¬¡ã® input ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯å¿…ãšæ–°ã—ã„ Undo ã‚°ãƒ«ãƒ¼ãƒ—ã«ã™ã‚‹
    nextInputForceNewGroup = true;
  const newContent = editorEl.value;
  const previousContent = state.content;

  // â˜… Enter ã‚­ãƒ¼ãªã©ã§ã€Œæ¬¡ã®å…¥åŠ›ã¯å¿…ãšæ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—ã€ã¨æŒ‡å®šã•ã‚ŒãŸå ´åˆã€
  //   ãã®ãƒ•ãƒ©ã‚°ã‚’ã“ã“ã§æ¸¡ã™
  pushUndo(previousContent, newContent, nextInputForceNewGroup);

  // ãƒ•ãƒ©ã‚°ã¯1å›ä½¿ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
  nextInputForceNewGroup = false;

  state.content = newContent;
  updateStats();
  scheduleAutosave();
  refreshAllUI();
  }
});


  filenameBaseEl.addEventListener('input', function() {
    state.title = filenameBaseEl.value.trim() || 'æ–‡ç« ä½œæˆ';
    updateFilenamePreview();
    scheduleAutosave();
  });

  saveButton.addEventListener('click', function() {
    handleBackupSave();
  });

  undoButton.addEventListener('click', function() {
    handleUndo();
  });

  redoButton.addEventListener('click', function() {
    handleRedo();
  });

  stepBackButton.addEventListener('click', function() {
    handleStepBack();
  });

  stepForwardButton.addEventListener('click', function() {
    handleStepForward();
  });

  restoreButton.addEventListener('click', function() {
    restoreFileInput.click();
  });

  restoreFileInput.addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    if (file) {
      handleBackupRestoreFile(file);
      // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«
      restoreFileInput.value = '';
    }
  });

  // ---------- init ----------
  updateFilenamePreview();
  updateStats();
  refreshAllUI();
  updateAutosaveUI('saving');

  // IndexedDB ã‚ªãƒ¼ãƒ—ãƒ³ & ãƒ­ãƒ¼ãƒ‰
  if ('indexedDB' in window) {
    openDatabase()
      .then(() => {
        loadStateFromIndexedDB();
      })
      .catch(err => {
        console.error('DB init error', err);
        updateAutosaveUI('error');
      });
  } else {
    console.warn('IndexedDB not supported');
    updateAutosaveUI('error');
    autosaveTextEl.textContent = 'IndexedDB éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶';
  }
})();
</script>
</body>
</html>
